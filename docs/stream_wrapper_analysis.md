# ğŸ“š OpenMOA Stream Wrapper æ·±åº¦åˆ†ææ–‡æ¡£

> **æ–‡ä»¶è·¯å¾„**: `src/openmoa/stream/stream_wrapper.py`
> **ç‰ˆæœ¬**: OpenMOA 0.0.1
> **åˆ†ææ—¥æœŸ**: 2026-02-10

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è§ˆä¸å®šä½](#1-æ¦‚è§ˆä¸å®šä½)
2. [ä»£ç ç»“æ„åˆ†è§£](#2-ä»£ç ç»“æ„åˆ†è§£)
3. [é€è¡Œ/é€å—è¯¦è§£](#3-é€è¡Œé€å—è¯¦è§£)
4. [æ•°æ®æµåˆ†æ](#4-æ•°æ®æµåˆ†æ)
5. [ä¾èµ–å…³ç³»](#5-ä¾èµ–å…³ç³»)
6. [ç‰¹æ®Šæœºåˆ¶ä¸æŠ€æœ¯ç‚¹](#6-ç‰¹æ®Šæœºåˆ¶ä¸æŠ€æœ¯ç‚¹)
7. [æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®](#7-æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®)
8. [ä½¿ç”¨ç¤ºä¾‹](#8-ä½¿ç”¨ç¤ºä¾‹)

---

## 1. æ¦‚è§ˆä¸å®šä½

### 1.1 ğŸ¯ æ–‡ä»¶çš„ä¸»è¦ç›®çš„å’ŒåŠŸèƒ½

`stream_wrapper.py` æ˜¯ OpenMOA æµå¤„ç†æ¡†æ¶çš„**æ ¸å¿ƒè£…é¥°å™¨æ¨¡å—ï¼ˆDecorator Moduleï¼‰**ï¼Œæä¾›äº†ä¸€å¥—ç”¨äº**æ¨¡æ‹Ÿç‰¹å¾ç©ºé—´åŠ¨æ€æ¼”åŒ–**çš„æµåŒ…è£…å™¨ï¼ˆStream Wrappersï¼‰ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å°†**é™æ€å›ºå®šç‰¹å¾ç©ºé—´çš„æ•°æ®é›†**è½¬æ¢ä¸º**ç‰¹å¾ç©ºé—´éšæ—¶é—´å˜åŒ–çš„åŠ¨æ€æ•°æ®æµ**
- æ¨¡æ‹ŸçœŸå®åœ¨çº¿å­¦ä¹ åœºæ™¯ä¸­çš„**ç‰¹å¾æ¼‚ç§»ï¼ˆFeature Driftï¼‰**ç°è±¡
- ä¸ºåœ¨çº¿å­¦ä¹ ç®—æ³•æä¾›**æ ‡å‡†åŒ–çš„ç‰¹å¾æ¼”åŒ–åŸºå‡†æµ‹è¯•ç¯å¢ƒ**

### 1.2 ğŸ—ï¸ åœ¨æ•´ä¸ªé¡¹ç›®ä¸­çš„è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     OpenMOA æ¶æ„å±‚æ¬¡å›¾                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚   Datasets      â”‚  â† æ•°æ®æ¥æºå±‚ (UCI/MOA/è‡ªå®šä¹‰)              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  Base Streams   â”‚  â† åŸºç¡€æµå±‚ (ARFF/CSV/LibSVM/Numpy)         â”‚
â”‚  â”‚  (_stream.py)   â”‚                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚  â”‚           Stream Wrappers  â­ æœ¬æ–‡ä»¶               â”‚            â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚            â”‚
â”‚  â”‚  â”‚ShuffledStreamâ”‚ â”‚ OpenFeatureStream       â”‚   â”‚            â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ TrapezoidalStream       â”‚   â”‚            â”‚
â”‚  â”‚                   â”‚ CapriciousStream        â”‚   â”‚            â”‚
â”‚  â”‚                   â”‚ EvolvableStream         â”‚   â”‚            â”‚
â”‚  â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚           â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  Learners       â”‚  â† å­¦ä¹ å™¨å±‚ (FOBOS/ORF3V/OVFM/HOT...)      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â”‚           â”‚                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                            â”‚
â”‚  â”‚  Evaluation     â”‚  â† è¯„ä¼°å±‚ (Prequential/Holdout/Drift)      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ğŸ”§ è§£å†³çš„å…·ä½“é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| **æ ‡ç­¾æ’åºåå·® (Label Sorting Bias)** | `ShuffledStream` æ‰“ä¹±å®ä¾‹é¡ºåº |
| **ç‰¹å¾ç©ºé—´ç»´åº¦å˜åŒ– (Varying Dimensionality)** | `OpenFeatureStream` è¾“å‡ºå˜é•¿å‘é‡ + å…¨å±€ç´¢å¼•æ˜ å°„ |
| **ç‰¹å¾æ¸è¿›å‡ºç° (Trapezoidal Data Stream)** | `TrapezoidalStream` / TDS æ¨¡å¼ |
| **ç‰¹å¾éšæœºç¼ºå¤± (Capricious Data Stream)** | `CapriciousStream` / CDS æ¨¡å¼ |
| **ç‰¹å¾åˆ†æ®µæ¼”åŒ– (Evolvable Data Stream)** | `EvolvableStream` / EDS æ¨¡å¼ |
| **ç´¢å¼•åç§»é—®é¢˜ (Index Shift Problem)** | `feature_indices` å…ƒæ•°æ®é™„åŠ  |
| **NaN å…¼å®¹æ€§ (Missing Value Compatibility)** | å›ºå®šç»´åº¦ + NaN å¡«å……æ–¹æ¡ˆ |

---

## 2. ä»£ç ç»“æ„åˆ†è§£

### 2.1 ğŸ“¦ ç±»æ¸…å•

| ç±»å | è¡Œå· | ç»§æ‰¿è‡ª | èŒè´£ |
|------|------|--------|------|
| `OpenFeatureStream` | 7-288 | `Stream` | å˜é•¿è¾“å‡ºçš„ç‰¹å¾æ¼”åŒ–åŒ…è£…å™¨ï¼ˆæ”¯æŒ6ç§æ¨¡å¼ï¼‰ |
| `TrapezoidalStream` | 290-457 | `Stream` | å›ºå®šç»´åº¦ + NaN å¡«å……çš„ TDS æ¨¡æ‹Ÿå™¨ |
| `CapriciousStream` | 460-572 | `Stream` | å›ºå®šç»´åº¦ + NaN å¡«å……çš„ CDS æ¨¡æ‹Ÿå™¨ |
| `EvolvableStream` | 576-772 | `Stream` | å›ºå®šç»´åº¦ + NaN å¡«å……çš„ EDS æ¨¡æ‹Ÿå™¨ |
| `ShuffledStream` | 776-836 | `Stream` | å†…å­˜ç¼“å†² + éšæœºæ‰“ä¹±åŒ…è£…å™¨ |

### 2.2 ğŸ” æ–¹æ³•æ¸…å•ï¼ˆæŒ‰ç±»åˆ†ç»„ï¼‰

#### OpenFeatureStream

| æ–¹æ³•å | è¡Œå· | å¯è§æ€§ | èŒè´£ |
|--------|------|--------|------|
| `__init__` | 30-101 | Public | åˆå§‹åŒ–å‚æ•°ã€é¢„è®¡ç®—æ—¶é—´è¡¨ |
| `_generate_dimension_schedule` | 103-114 | Private | ç”Ÿæˆç»´åº¦å˜åŒ–æ—¶é—´è¡¨ï¼ˆpyramid/inc/decï¼‰ |
| `_generate_feature_indices` | 116-132 | Private | é¢„è®¡ç®—æ¯æ—¶åˆ»çš„æ´»è·ƒç‰¹å¾ç´¢å¼• |
| `_generate_tds_offsets` | 134-157 | Private | ä¸ºæ¯ä¸ªç‰¹å¾åˆ†é…"å‡ºç”Ÿæ—¶é—´" |
| `_generate_eds_partitions` | 159-164 | Private | å°†ç‰¹å¾ç©ºé—´åˆ†å‰²ä¸º n ä¸ªåˆ†åŒº |
| `_calculate_eds_boundaries` | 166-186 | Private | è®¡ç®— EDS å„é˜¶æ®µçš„æ—¶é—´è¾¹ç•Œ |
| `_get_active_indices` | 188-236 | Private | **æ ¸å¿ƒé€»è¾‘å¼•æ“**ï¼šè¿”å›å½“å‰æ´»è·ƒç‰¹å¾ ID |
| `next_instance` | 238-273 | Public | è¿”å›ä¸‹ä¸€ä¸ªæ¼”åŒ–åçš„å®ä¾‹ |
| `has_more_instances` | 275-276 | Public | æ£€æŸ¥æ˜¯å¦è¿˜æœ‰æ›´å¤šå®ä¾‹ |
| `restart` | 278-280 | Public | é‡ç½®æµçŠ¶æ€ |
| `get_schema` | 282-284 | Public | è¿”å›åŸå§‹ Schema |
| `get_moa_stream` | 286-287 | Public | è¿”å› Noneï¼ˆçº¯ Python å®ç°ï¼‰ |

#### TrapezoidalStream

| æ–¹æ³•å | è¡Œå· | å¯è§æ€§ | èŒè´£ |
|--------|------|--------|------|
| `__init__` | 310-359 | Public | åˆå§‹åŒ–ã€è®¡ç®—ç‰¹å¾ä¼˜å…ˆçº§æ’å |
| `_generate_feature_ranking` | 361-378 | Private | ç¡®å®šç‰¹å¾çš„"å‡ºç”Ÿä¼˜å…ˆçº§" |
| `_generate_dimension_schedule` | 380-399 | Private | è®¡ç®—æ¯æ—¶åˆ»çš„æ´»è·ƒç‰¹å¾æ•° k |
| `next_instance` | 401-441 | Public | è¿”å›å›ºå®šç»´åº¦ + NaN å¡«å……çš„å®ä¾‹ |
| `has_more_instances` | 443-447 | Public | æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶ |
| `restart` | 449-451 | Public | é‡ç½®æµçŠ¶æ€ |
| `get_schema` | 453-454 | Public | è¿”å› Schema |
| `get_moa_stream` | 456-457 | Public | è¿”å› None |

#### CapriciousStream

| æ–¹æ³•å | è¡Œå· | å¯è§æ€§ | èŒè´£ |
|--------|------|--------|------|
| `__init__` | 470-500 | Public | åˆå§‹åŒ–ç¼ºå¤±ç‡å‚æ•° |
| `_get_feature_mask` | 502-522 | Private | ä¼¯åŠªåˆ©è¯•éªŒç”Ÿæˆç¼ºå¤±æ©ç  |
| `next_instance` | 524-556 | Public | è¿”å›éšæœºç¼ºå¤±çš„å®ä¾‹ |
| `has_more_instances` | 558-562 | Public | æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶ |
| `restart` | 564-566 | Public | é‡ç½®æµçŠ¶æ€ |
| `get_schema` | 568-569 | Public | è¿”å› Schema |
| `get_moa_stream` | 571-572 | Public | è¿”å› None |

#### EvolvableStream

| æ–¹æ³•å | è¡Œå· | å¯è§æ€§ | èŒè´£ |
|--------|------|--------|------|
| `__init__` | 594-636 | Public | åˆå§‹åŒ–åˆ†æ®µå‚æ•° |
| `_generate_partitions` | 638-646 | Private | é¡ºåºåˆ’åˆ†ç‰¹å¾ç©ºé—´ |
| `_calculate_boundaries` | 648-676 | Private | è®¡ç®—é˜¶æ®µè¾¹ç•Œ |
| `_get_active_mask` | 678-715 | Private | è¿”å›å¸ƒå°”æ´»è·ƒæ©ç  |
| `next_instance` | 717-755 | Public | è¿”å›é˜¶æ®µæ€§æ¼”åŒ–çš„å®ä¾‹ |
| `has_more_instances` | 757-761 | Public | æ£€æŸ¥ç»ˆæ­¢æ¡ä»¶ |
| `restart` | 763-765 | Public | é‡ç½®æµçŠ¶æ€ |
| `get_schema` | 767-768 | Public | è¿”å› Schema |
| `get_moa_stream` | 770-771 | Public | è¿”å› None |

#### ShuffledStream

| æ–¹æ³•å | è¡Œå· | å¯è§æ€§ | èŒè´£ |
|--------|------|--------|------|
| `__init__` | 784-806 | Public | åŠ è½½å…¨éƒ¨æ•°æ®ã€ç”Ÿæˆæ‰“ä¹±ç´¢å¼• |
| `has_more_instances` | 808-809 | Public | æ£€æŸ¥æŒ‡é’ˆä½ç½® |
| `next_instance` | 811-820 | Public | æŒ‰æ‰“ä¹±é¡ºåºè¿”å›å®ä¾‹ |
| `restart` | 822-826 | Public | é‡ç½®æŒ‡é’ˆ |
| `get_schema` | 828-829 | Public | è¿”å› Schema |
| `get_num_instances` | 831-833 | Public | è¿”å›æ€»å®ä¾‹æ•° |
| `get_moa_stream` | 835-836 | Public | è¿”å› None |

### 2.3 ğŸ”— ç»„ä»¶è°ƒç”¨å…³ç³»å›¾

```
å¤–éƒ¨è°ƒç”¨æ–¹ (demo/benchmark)
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     ShuffledStream                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ __init__:                                            â”‚ â”‚
â”‚   â”‚   while base.has_more_instances():                   â”‚ â”‚
â”‚   â”‚       _instances.append(base.next_instance())        â”‚ â”‚
â”‚   â”‚   _indices = shuffle(range(n))                       â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ next_instance:                                       â”‚ â”‚
â”‚   â”‚   return _instances[_indices[_ptr++]]                â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ (ä½œä¸º base_stream ä¼ å…¥)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   OpenFeatureStream                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ __init__:                                            â”‚ â”‚
â”‚   â”‚   æ ¹æ® evolution_pattern è°ƒç”¨å¯¹åº”çš„é¢„è®¡ç®—æ–¹æ³•:         â”‚ â”‚
â”‚   â”‚   â”œâ”€â”€ pyramid/inc/dec â†’ _generate_dimension_schedule â”‚ â”‚
â”‚   â”‚   â”‚                   â†’ _generate_feature_indices    â”‚ â”‚
â”‚   â”‚   â”œâ”€â”€ tds â†’ _generate_tds_offsets                    â”‚ â”‚
â”‚   â”‚   â””â”€â”€ eds â†’ _generate_eds_partitions                 â”‚ â”‚
â”‚   â”‚           â†’ _calculate_eds_boundaries                â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚   â”‚ next_instance:                                       â”‚ â”‚
â”‚   â”‚   1. base_stream.next_instance()                     â”‚ â”‚
â”‚   â”‚   2. _get_active_indices(t) â† æ ¹æ®æ¨¡å¼åˆ†å‘           â”‚ â”‚
â”‚   â”‚   3. x_subset = x_full[active_indices]               â”‚ â”‚
â”‚   â”‚   4. LabeledInstance.from_array(schema, x_subset, y) â”‚ â”‚
â”‚   â”‚   5. instance.feature_indices = active_indices       â”‚ â”‚
â”‚   â”‚   6. return instance                                 â”‚ â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
                   FOBOSClassifier
                        â”‚
                        â–¼
               _get_sparse_x(instance)
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
  feature_indices?   x_index/x_value?   else
        â”‚               â”‚               â”‚
        â–¼               â–¼               â–¼
 return (indices,   return (x_index,  filter(x!=0 & !nan)
         inst.x)         x_value)
```

---

## 3. é€è¡Œ/é€å—è¯¦è§£

### 3.1 ğŸ”§ å¯¼å…¥ä¸ç±»å‹å£°æ˜ (Lines 1-6)

```python
import numpy as np                                    # æ•°å€¼è®¡ç®—æ ¸å¿ƒåº“
from typing import Literal, Optional, List            # ç±»å‹æ³¨è§£
from openmoa.stream import Stream                     # æµåŸºç±»
from openmoa.stream._stream import Schema             # æµç»“æ„æè¿°
from openmoa.instance import LabeledInstance, RegressionInstance  # å®ä¾‹ç±»å‹
```

**è®¾è®¡æ„å›¾**ï¼š
- ä½¿ç”¨ `Literal` ç±»å‹é™åˆ¶å‚æ•°å–å€¼èŒƒå›´ï¼ŒIDE å¯æä¾›è‡ªåŠ¨è¡¥å…¨
- å¯¼å…¥ `Stream` åŸºç±»ç¡®ä¿æ‰€æœ‰åŒ…è£…å™¨éµå¾ªç»Ÿä¸€æ¥å£

---

### 3.2 ğŸ“ OpenFeatureStream è¯¦è§£

#### 3.2.1 æ„é€ å‡½æ•° (Lines 30-101)

```python
def __init__(
    self,
    base_stream: Stream,                              # åŸå§‹æ•°æ®æµ
    d_min: int = 2,                                   # æœ€å°æ´»è·ƒç‰¹å¾æ•°
    d_max: Optional[int] = None,                      # æœ€å¤§ç‰¹å¾æ•°ï¼ˆé»˜è®¤=åŸå§‹ç»´åº¦ï¼‰
    evolution_pattern: Literal["pyramid", ...] = "pyramid",  # æ¼”åŒ–æ¨¡å¼
    total_instances: int = 10000,                     # æµæ€»é•¿åº¦ï¼ˆç”¨äºè®¡ç®—æ—¶é—´è¡¨ï¼‰
    feature_selection: Literal["prefix", ...] = "prefix",    # ç‰¹å¾é€‰æ‹©ç­–ç•¥
    missing_ratio: float = 0.0,                       # CDS ç¼ºå¤±ç‡
    random_seed: int = 42,                            # éšæœºç§å­
    tds_mode: Literal["random", "ordered"] = "random",       # TDS æ¨¡å¼
    n_segments: int = 2,                              # EDS åˆ†æ®µæ•°
    overlap_ratio: float = 1.0,                       # EDS é‡å æ¯”ä¾‹
):
```

**å‚æ•°å–å€¼èŒƒå›´**ï¼š

| å‚æ•° | ç±»å‹ | å–å€¼èŒƒå›´ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|----------|--------|------|
| `d_min` | int | [1, d_max] | 2 | æœ€å°‘ä¿ç•™çš„æ´»è·ƒç‰¹å¾æ•° |
| `d_max` | int | [d_min, åŸå§‹ç»´åº¦] | None(=åŸå§‹ç»´åº¦) | ç‰¹å¾ç©ºé—´ä¸Šç•Œ |
| `evolution_pattern` | str | pyramid/incremental/decremental/tds/cds/eds | "pyramid" | æ¼”åŒ–ç­–ç•¥ |
| `total_instances` | int | > 0 | 10000 | æµé•¿åº¦ï¼Œç”¨äºè®¡ç®—æ—¶é—´è½´ |
| `feature_selection` | str | prefix/suffix/random | "prefix" | ç¡®å®šæ€§æ¨¡å¼çš„ç‰¹å¾é€‰å–æ–¹å¼ |
| `missing_ratio` | float | [0.0, 1.0) | 0.0 | CDS æ¨¡å¼çš„ç‰¹å¾ç¼ºå¤±æ¦‚ç‡ |
| `tds_mode` | str | random/ordered | "random" | TDS çš„ç‰¹å¾å‡ºç”Ÿé¡ºåº |
| `n_segments` | int | >= 2 | 2 | EDS çš„åˆ†åŒºæ•° |
| `overlap_ratio` | float | >= 0 | 1.0 | EDS é‡å æœŸä¸ç¨³å®šæœŸçš„æ¯”å€¼ |

**å…³é”®åˆå§‹åŒ–é€»è¾‘**ï¼š

```python
# éªŒè¯ d_max ä¸è¶…è¿‡åŸå§‹ç»´åº¦
original_d = base_stream.get_schema().get_num_attributes()
self.d_max = d_max if d_max is not None else original_d
if self.d_max > original_d:
    raise ValueError(f"d_max ({self.d_max}) cannot exceed original feature count ({original_d})")

# åˆ›å»ºå¯å¤ç°çš„éšæœºæ•°ç”Ÿæˆå™¨
self._rng = np.random.RandomState(random_seed)
self._current_t = 0  # æ—¶é—´æ­¥è®¡æ•°å™¨

# æ ¹æ®æ¨¡å¼é¢„è®¡ç®—
if evolution_pattern in ["pyramid", "incremental", "decremental"]:
    self._dimension_schedule = self._generate_dimension_schedule()    # ç»´åº¦æ—¶é—´è¡¨
    self._feature_indices_cache = self._generate_feature_indices()    # ç´¢å¼•ç¼“å­˜
elif evolution_pattern == "tds":
    self._feature_offsets = self._generate_tds_offsets()              # ç‰¹å¾å‡ºç”Ÿæ—¶é—´
elif evolution_pattern == "eds":
    self._eds_partitions = self._generate_eds_partitions()            # ç‰¹å¾åˆ†åŒº
    self._eds_boundaries = self._calculate_eds_boundaries()           # é˜¶æ®µè¾¹ç•Œ
# cds æ¨¡å¼æ˜¯éšæœºçš„ï¼Œæ— éœ€é¢„è®¡ç®—
```

> ğŸ’¡ **è®¾è®¡æ¨¡å¼ï¼šç­–ç•¥æ¨¡å¼ (Strategy Pattern)**
> ä¸åŒæ¼”åŒ–æ¨¡å¼é€šè¿‡ `evolution_pattern` å‚æ•°é€‰æ‹©ï¼Œåˆå§‹åŒ–å’Œè¿è¡Œæ—¶é€»è¾‘éƒ½é€šè¿‡æ¡ä»¶åˆ†æ”¯åˆ†å‘åˆ°å¯¹åº”ç­–ç•¥ã€‚

---

#### 3.2.2 ç»´åº¦æ—¶é—´è¡¨ç”Ÿæˆ (Lines 103-114)

```python
def _generate_dimension_schedule(self) -> np.ndarray:
    """ç”Ÿæˆæ¯ä¸ªæ—¶é—´æ­¥çš„ç›®æ ‡ç»´åº¦æ•°"""
    dims = np.zeros(self.total_instances, dtype=int)

    if self.evolution_pattern == "pyramid":
        half = self.total_instances // 2
        dims[:half] = np.linspace(self.d_min, self.d_max, half)   # å‰åŠæ®µï¼šä¸Šå‡
        dims[half:] = np.linspace(self.d_max, self.d_min, self.total_instances - half)  # ååŠæ®µï¼šä¸‹é™

    elif self.evolution_pattern == "incremental":
        dims = np.linspace(self.d_min, self.d_max, self.total_instances)  # å•è°ƒé€’å¢

    elif self.evolution_pattern == "decremental":
        dims = np.linspace(self.d_max, self.d_min, self.total_instances)  # å•è°ƒé€’å‡

    return dims.astype(int)
```

**å¯è§†åŒ–ç¤ºä¾‹**ï¼ˆtotal_instances=1000, d_min=2, d_max=10ï¼‰ï¼š

```
Pyramid:          Incremental:      Decremental:
    ^                   ^                 ^
10 -|    /\          10-|        ___   10-|___
    |   /  \            |       /         |   \
    |  /    \           |      /          |    \
 2 -|_/      \_       2-|_____/         2-|     \___
    +----------â†’        +--------â†’        +--------â†’
    0   500  1000       0      1000       0      1000
```

---

#### 3.2.3 ç‰¹å¾ç´¢å¼•é¢„è®¡ç®— (Lines 116-132)

```python
def _generate_feature_indices(self) -> list:
    """ä¸ºæ¯ä¸ªæ—¶é—´æ­¥é¢„è®¡ç®—å…·ä½“çš„ç‰¹å¾ç´¢å¼•"""
    indices_list = []
    for t in range(self.total_instances):
        d_current = self._dimension_schedule[t]     # å½“å‰æ—¶åˆ»çš„ç›®æ ‡ç»´åº¦

        if self.feature_selection == "prefix":
            indices = np.arange(d_current)           # é€‰æ‹©å‰ d_current ä¸ªç‰¹å¾
            # ä¾‹ï¼šd_current=3 â†’ [0, 1, 2]

        elif self.feature_selection == "suffix":
            indices = np.arange(self.d_max - d_current, self.d_max)  # é€‰æ‹©å d_current ä¸ª
            # ä¾‹ï¼šd_max=10, d_current=3 â†’ [7, 8, 9]

        elif self.feature_selection == "random":
            rng_t = np.random.RandomState(self.random_seed + t)  # æ—¶é—´æ­¥ç›¸å…³çš„éšæœºç§å­
            indices = rng_t.choice(self.d_max, d_current, replace=False)
            indices.sort()
            # ä¾‹ï¼šd_max=10, d_current=3 â†’ [2, 5, 8] (éšæœºé€‰æ‹©ä½†æ’åºåè¾“å‡º)

        indices_list.append(indices)
    return indices_list
```

> ğŸ’¡ **å¯å¤ç°æ€§æŠ€å·§**ï¼š`random` æ¨¡å¼ä½¿ç”¨ `random_seed + t` ä½œä¸ºç§å­ï¼Œç¡®ä¿åŒä¸€æ—¶é—´æ­¥åœ¨ä¸åŒè¿è¡Œä¸­äº§ç”Ÿç›¸åŒç»“æœã€‚

---

#### 3.2.4 TDS åç§»é‡ç”Ÿæˆ (Lines 134-157)

```python
def _generate_tds_offsets(self) -> np.ndarray:
    """ä¸ºæ¯ä¸ªç‰¹å¾åˆ†é…"å‡ºç”Ÿæ—¶é—´"(birth time)"""
    offsets = np.zeros(self.d_max, dtype=int)
    time_step = self.total_instances // 10   # å°†æ—¶é—´çº¿åˆ†ä¸º10ä¸ªé˜¶æ®µ

    if self.tds_mode == "random":
        # éšæœºæ‰“ä¹±ç‰¹å¾é¡ºåºï¼Œå‡åŒ€åˆ†é…åˆ°10ä¸ªé˜¶æ®µ
        indices = self._rng.permutation(self.d_max)
        for i in range(self.d_max):
            offsets[indices[i]] = (i % 10) * time_step
        # ä¾‹ï¼šd_max=30, indices=[5,12,0,...]
        #     Feature 5 â†’ bucket 0 â†’ offset 0
        #     Feature 12 â†’ bucket 1 â†’ offset 100
        #     Feature 0 â†’ bucket 2 â†’ offset 200

    elif self.tds_mode == "ordered":
        # æŒ‰ç‰¹å¾ç´¢å¼•é¡ºåºåˆ†é…ï¼ˆç‰¹å¾0å…ˆå‡ºç”Ÿï¼Œç‰¹å¾N-1æœ€åå‡ºç”Ÿï¼‰
        for i in range(self.d_max):
            bucket = (i * 10) // self.d_max   # å°†ç´¢å¼•æ˜ å°„åˆ°0-9
            offsets[i] = bucket * time_step
        # ä¾‹ï¼šd_max=30
        #     Feature 0-2 â†’ bucket 0 â†’ offset 0
        #     Feature 3-5 â†’ bucket 1 â†’ offset 100
        #     ...

    return offsets
```

**TDS Ordered æ¨¡å¼å¯è§†åŒ–**ï¼ˆd_max=10, total_instances=1000ï¼‰ï¼š

```
ç‰¹å¾ç´¢å¼•:    0  1  2  3  4  5  6  7  8  9
å‡ºç”Ÿæ—¶é—´:    0  0  0  100 100 200 200 300 300 400
            |________|________|________|________|
              Bucket0  Bucket1  Bucket2  Bucket3

æ—¶é—´çº¿æ¼”ç¤º:
t=0:   æ´»è·ƒç‰¹å¾ = [0,1,2]                    (3ä¸ª)
t=150: æ´»è·ƒç‰¹å¾ = [0,1,2,3,4]                (5ä¸ª)
t=350: æ´»è·ƒç‰¹å¾ = [0,1,2,3,4,5,6,7]          (8ä¸ª)
t=500: æ´»è·ƒç‰¹å¾ = [0,1,2,3,4,5,6,7,8,9]      (å…¨éƒ¨10ä¸ª)
```

---

#### 3.2.5 EDS åˆ†åŒºä¸è¾¹ç•Œè®¡ç®— (Lines 159-186)

```python
def _generate_eds_partitions(self) -> List[np.ndarray]:
    """å°†ç‰¹å¾ç©ºé—´é¡ºåºåˆ’åˆ†ä¸º n ä¸ªä¸ç›¸äº¤çš„å­é›†"""
    all_indices = np.arange(self.d_max)
    partitions = np.array_split(all_indices, self.n_segments)
    return [np.sort(p) for p in partitions]
    # ä¾‹ï¼šd_max=10, n_segments=3
    #     â†’ [[0,1,2,3], [4,5,6], [7,8,9]]

def _calculate_eds_boundaries(self) -> List[int]:
    """è®¡ç®— EDS å„é˜¶æ®µçš„æ—¶é—´è¾¹ç•Œ"""
    n = self.n_segments
    r = self.overlap_ratio

    # å…¬å¼æ¨å¯¼ï¼š
    # æ€»æ—¶é—´ = nä¸ªç¨³å®šæœŸ + (n-1)ä¸ªé‡å æœŸ
    # æ€»æ—¶é—´ = n*L + (n-1)*r*L = L * (n + r*(n-1))
    # è§£å‡º L = total_instances / (n + r*(n-1))
    L = self.total_instances / (n + r * (n - 1))

    boundaries = []
    current_pos = 0.0
    total_stages = 2 * n - 1   # ç¨³å®šå’Œé‡å äº¤æ›¿

    for i in range(total_stages):
        if i % 2 == 0:  # å¶æ•°ç´¢å¼• = ç¨³å®šæœŸ
            current_pos += L
        else:           # å¥‡æ•°ç´¢å¼• = é‡å æœŸ
            current_pos += L * r
        boundaries.append(int(current_pos))

    boundaries[-1] = self.total_instances  # ç¡®ä¿æœ€åä¸€ä¸ªè¾¹ç•Œç²¾ç¡®
    return boundaries
```

**EDS æ¼”åŒ–å›¾ç¤º**ï¼ˆn_segments=3, overlap_ratio=1.0, total=1000ï¼‰ï¼š

```
L = 1000 / (3 + 1.0*(3-1)) = 1000 / 5 = 200

é˜¶æ®µè¾¹ç•Œ: [200, 400, 600, 800, 1000]

Stage 0 (t=0~199):    P0 æ´»è·ƒ       [0,1,2,3]
Stage 1 (t=200~399):  P0 âˆª P1      [0,1,2,3,4,5,6]      â† é‡å æœŸ
Stage 2 (t=400~599):  P1 æ´»è·ƒ       [4,5,6]
Stage 3 (t=600~799):  P1 âˆª P2      [4,5,6,7,8,9]        â† é‡å æœŸ
Stage 4 (t=800~999):  P2 æ´»è·ƒ       [7,8,9]

å¯è§†åŒ–:
        â”Œâ”€â”€â”€â”€â”€â”€â”
    P0  â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
        â””â”€â”€â”€â”€â”€â”€â”˜
             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    P0âˆªP1    â”‚              â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”Œâ”€â”€â”€â”€â”€â”€â”
    P1            â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
                  â””â”€â”€â”€â”€â”€â”€â”˜
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    P1âˆªP2              â”‚              â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”Œâ”€â”€â”€â”€â”€â”€â”
    P2                      â”‚â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ”‚
                            â””â”€â”€â”€â”€â”€â”€â”˜
        +------+------+------+------+------â†’ t
        0     200    400    600    800   1000
```

---

#### 3.2.6 æ ¸å¿ƒé€»è¾‘å¼•æ“ï¼š_get_active_indices (Lines 188-236)

```python
def _get_active_indices(self, t: int) -> np.ndarray:
    """
    ğŸ”¥ è¿™æ˜¯æ•´ä¸ªç±»çš„å†³ç­–æ ¸å¿ƒ
    è¾“å…¥: å½“å‰æ—¶é—´æ­¥ t
    è¾“å‡º: å½“å‰åº”è¯¥æ´»è·ƒçš„å…¨å±€ç‰¹å¾IDæ•°ç»„
    """

    # 1ï¸âƒ£ ç¡®å®šæ€§æ¨¡å¼ï¼ˆpyramid/incremental/decrementalï¼‰
    if self.evolution_pattern in ["pyramid", "incremental", "decremental"]:
        if t < len(self._feature_indices_cache):
            return self._feature_indices_cache[t]  # ç›´æ¥æŸ¥è¡¨
        return np.arange(self.d_min)  # è¶Šç•Œä¿æŠ¤

    # 2ï¸âƒ£ TDS æ¨¡å¼
    elif self.evolution_pattern == "tds":
        # è¿”å›æ‰€æœ‰ offset <= t çš„ç‰¹å¾
        return np.where(self._feature_offsets <= t)[0]

    # 3ï¸âƒ£ CDS æ¨¡å¼ï¼ˆéšæœºç¼ºå¤±ï¼‰
    elif self.evolution_pattern == "cds":
        rng_t = np.random.RandomState(self.random_seed + t)
        # ä¼¯åŠªåˆ©è¯•éªŒï¼šä»¥ (1-missing_ratio) çš„æ¦‚ç‡ä¿ç•™ç‰¹å¾
        mask = rng_t.rand(self.d_max) > self.missing_ratio
        indices = np.where(mask)[0]
        if len(indices) == 0:
            indices = np.array([0])  # ä¿åº•ï¼šè‡³å°‘ä¿ç•™ä¸€ä¸ªç‰¹å¾
        return indices

    # 4ï¸âƒ£ EDS æ¨¡å¼ï¼ˆåˆ†æ®µæ¼”åŒ–ï¼‰
    elif self.evolution_pattern == "eds":
        # æ‰¾åˆ°å½“å‰æ‰€å±çš„é˜¶æ®µ
        stage_idx = 0
        for i, boundary in enumerate(self._eds_boundaries):
            if t < boundary:
                stage_idx = i
                break
        else:
            stage_idx = len(self._eds_boundaries) - 1

        if stage_idx % 2 == 0:
            # å¶æ•°é˜¶æ®µï¼šç¨³å®šæœŸï¼Œå•ä¸ªåˆ†åŒºæ´»è·ƒ
            partition_idx = stage_idx // 2
            return self._eds_partitions[partition_idx]
        else:
            # å¥‡æ•°é˜¶æ®µï¼šé‡å æœŸï¼Œç›¸é‚»ä¸¤ä¸ªåˆ†åŒºéƒ½æ´»è·ƒ
            prev = (stage_idx - 1) // 2
            indices = np.concatenate([
                self._eds_partitions[prev],
                self._eds_partitions[prev + 1]
            ])
            indices.sort()
            return indices

    return np.arange(self.d_max)  # é»˜è®¤ï¼šæ‰€æœ‰ç‰¹å¾æ´»è·ƒ
```

> ğŸ”‘ **å…³é”®æ´å¯Ÿ**ï¼šè¿™ä¸ªæ–¹æ³•æ˜¯çº¯å‡½æ•°ï¼ˆPure Functionï¼‰ï¼Œå¯¹äºç›¸åŒçš„ `t` å’Œåˆå§‹åŒ–å‚æ•°ï¼Œæ€»æ˜¯è¿”å›ç›¸åŒçš„ç»“æœã€‚è¿™ä½¿å¾—æ•´ä¸ªæµæ˜¯**å¯å¤ç°çš„ï¼ˆReproducibleï¼‰**ã€‚

---

#### 3.2.7 å®ä¾‹ç”Ÿæˆæ ¸å¿ƒï¼šnext_instance (Lines 238-273)

```python
def next_instance(self):
    """è¿”å›ä¸‹ä¸€ä¸ªç‰¹å¾æ¼”åŒ–åçš„å®ä¾‹"""
    if not self.has_more_instances():
        return None

    # Step 1: ä»åº•å±‚æµè·å–åŸå§‹å®ä¾‹
    base_instance = self.base_stream.next_instance()
    if base_instance is None:
        return None

    # Step 2: ç¡®å®šå½“å‰æ´»è·ƒçš„å…¨å±€ç‰¹å¾ ID
    active_indices = self._get_active_indices(self._current_t)

    # Step 3: ä»å®Œæ•´ç‰¹å¾å‘é‡ä¸­åˆ‡ç‰‡
    x_full = np.array(base_instance.x)
    # é˜²å¾¡æ€§ç¼–ç¨‹ï¼šç¡®ä¿ç´¢å¼•ä¸è¶Šç•Œ
    valid_indices = active_indices[active_indices < len(x_full)]
    if len(valid_indices) == 0:
        valid_indices = np.array([0])

    x_subset = x_full[valid_indices]  # ç‰©ç†æˆªçŸ­

    # Step 4: æ„å»ºæ–°çš„ Instance å¯¹è±¡
    if self._schema.is_classification():
        new_instance = LabeledInstance.from_array(
            self._schema, x_subset, base_instance.y_index
        )
    else:
        new_instance = RegressionInstance.from_array(
            self._schema, x_subset, base_instance.y_value
        )

    # Step 5: ğŸ”¥ é™„åŠ å…¨å±€ç‰¹å¾ç´¢å¼•ï¼ˆè§£å†³ Index Shift é—®é¢˜ï¼‰
    new_instance.feature_indices = valid_indices

    self._current_t += 1
    return new_instance
```

**æ•°æ®å˜æ¢å¯è§†åŒ–**ï¼š

```
è¾“å…¥ (æ¥è‡ª base_stream):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ x_full = [0.1, 0.2, 0.3, 0.4, 0.5, 0.6]    â”‚  (6ç»´)
â”‚ y_index = 1                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ _get_active_indices(t=100)
                    â”‚ è¿”å› [1, 3, 5] (å‡è®¾ TDS æ¨¡å¼)
                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ valid_indices = [1, 3, 5]                   â”‚
â”‚ x_subset = x_full[[1,3,5]] = [0.2, 0.4, 0.6]â”‚  (3ç»´)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ æ„å»ºæ–°å®ä¾‹
                    â”‚
è¾“å‡º (ä¼ ç»™ Learner):
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ new_instance.x = [0.2, 0.4, 0.6]           â”‚  (ç‰©ç†3ç»´)
â”‚ new_instance.y_index = 1                    â”‚
â”‚ new_instance.feature_indices = [1, 3, 5]    â”‚  â† å…¨å±€IDå…ƒæ•°æ®
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

> ğŸ”‘ **Index Shift é—®é¢˜è§£å†³æ–¹æ¡ˆ**ï¼š
> è™½ç„¶ç‰©ç†å‘é‡æ˜¯ `[0.2, 0.4, 0.6]`ï¼ˆä½ç½®0,1,2ï¼‰ï¼Œä½† `feature_indices=[1,3,5]` å‘Šè¯‰å­¦ä¹ å™¨è¿™äº›å€¼å¯¹åº”çš„æ˜¯**å…¨å±€ç‰¹å¾1ã€3ã€5**ã€‚å­¦ä¹ å™¨æ›´æ–°æƒé‡æ—¶ä¼šå†™å…¥ `W[[1,3,5]]` è€Œé `W[[0,1,2]]`ã€‚

---

### 3.3 ğŸ“ TrapezoidalStream è¯¦è§£

ä¸ `OpenFeatureStream` çš„æ ¸å¿ƒåŒºåˆ«åœ¨ `next_instance` æ–¹æ³•ï¼š

```python
def next_instance(self):
    # ...
    # 1. è·å–å½“å‰æ´»è·ƒç‰¹å¾æ•° k
    t_idx = min(self._current_t, self.total_instances - 1)
    num_active = self._dimension_schedule[t_idx]

    # 2. ç¡®å®šå“ªäº›ç‰¹å¾æ´»è·ƒï¼ˆåŸºäºä¼˜å…ˆçº§æ’åï¼‰
    active_indices = self._feature_ranking[:num_active]

    # 3. åˆ›å»º NaN ç”»å¸ƒï¼ˆå›ºå®šç»´åº¦ï¼‰
    x_full = np.full(self.d_max, np.nan)  # ğŸ”¥ å…³é”®ï¼šé¢„å¡«å…… NaN

    # 4. åªå¡«å…¥æ´»è·ƒä½ç½®çš„å€¼
    x_base = np.array(base_instance.x)[:self.d_max]
    x_full[active_indices] = x_base[active_indices]

    # 5. æ„å»ºå®ä¾‹ï¼ˆç»´åº¦å§‹ç»ˆ = d_maxï¼‰
    modified_instance = LabeledInstance.from_array(
        self._schema, x_full, base_instance.y_index
    )
    # æ³¨æ„ï¼šè¿™é‡Œæ²¡æœ‰ feature_indices å…ƒæ•°æ®ï¼
    # ...
```

**å¯¹æ¯”è¡¨**ï¼š

| ç‰¹æ€§ | OpenFeatureStream | TrapezoidalStream |
|------|-------------------|-------------------|
| è¾“å‡ºå‘é‡ç»´åº¦ | å¯å˜ï¼ˆ= æ´»è·ƒç‰¹å¾æ•°ï¼‰ | å›ºå®šï¼ˆ= d_maxï¼‰ |
| ä¸æ´»è·ƒç‰¹å¾è¡¨ç¤º | ä¸å­˜åœ¨äºå‘é‡ä¸­ | `np.nan` å ä½ |
| `feature_indices` å…ƒæ•°æ® | âœ… æœ‰ | âŒ æ—  |
| é€‚ç”¨ç®—æ³• | ç¨€ç–æ„ŸçŸ¥ï¼ˆFOBOS, FTRLï¼‰ | NaN å¤„ç†ï¼ˆOVFM, OSLMFï¼‰ |
| å†…å­˜æ•ˆç‡ | æ›´é«˜ï¼ˆçŸ­å‘é‡ï¼‰ | è¾ƒä½ï¼ˆå…¨é•¿å‘é‡ï¼‰ |

---

### 3.4 ğŸ“ ShuffledStream è¯¦è§£

```python
class ShuffledStream(Stream):
    def __init__(self, base_stream: Stream, random_seed: int = 42):
        # 1ï¸âƒ£ ç«‹å³åŠ è½½å…¨éƒ¨æ•°æ®åˆ°å†…å­˜
        self._instances = []
        while base_stream.has_more_instances():
            try:
                inst = base_stream.next_instance()
                if inst is not None:
                    self._instances.append(inst)
            except Exception:
                break

        self.n_instances = len(self._instances)

        # 2ï¸âƒ£ åˆ›å»ºæ‰“ä¹±çš„ç´¢å¼•æ˜ å°„
        self._indices = np.arange(self.n_instances)
        self._rng = np.random.RandomState(random_seed)
        self._rng.shuffle(self._indices)

        self._ptr = 0  # å½“å‰è¯»å–æŒ‡é’ˆ

    def next_instance(self):
        if not self.has_more_instances():
            return None
        # æŒ‰æ‰“ä¹±åçš„ç´¢å¼•è®¿é—®
        real_idx = self._indices[self._ptr]
        instance = self._instances[real_idx]
        self._ptr += 1
        return instance
```

**å†…å­˜æ¨¡å‹**ï¼š

```
åŸå§‹æµ:     [inst_0, inst_1, inst_2, inst_3, inst_4, inst_5]
                â”‚
                â–¼ å…¨éƒ¨åŠ è½½
å†…å­˜åˆ—è¡¨:   [inst_0, inst_1, inst_2, inst_3, inst_4, inst_5]
                â”‚
                â–¼ ç”Ÿæˆç´¢å¼•å¹¶æ‰“ä¹±
ç´¢å¼•æ•°ç»„:   [3, 0, 5, 1, 4, 2]
                â”‚
                â–¼ æŒ‰æ‰“ä¹±ç´¢å¼•è®¿é—®
è¾“å‡ºé¡ºåº:   inst_3 â†’ inst_0 â†’ inst_5 â†’ inst_1 â†’ inst_4 â†’ inst_2
```

> âš ï¸ **è­¦å‘Š**ï¼šæ­¤ç±»ä¼šå°†æ•´ä¸ªæ•°æ®é›†åŠ è½½åˆ°å†…å­˜ï¼Œä»…é€‚ç”¨äº UCI é‡çº§ï¼ˆMBï¼‰æ•°æ®é›†ã€‚å¯¹äº GB çº§å¤§æ•°æ®æµï¼Œè¿™ä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚

---

## 4. æ•°æ®æµåˆ†æ

### 4.1 å®Œæ•´æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              æ•°æ®æµå…¨æ™¯å›¾                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚   ç£ç›˜æ–‡ä»¶        â”‚                                                       â”‚
â”‚  â”‚ .arff/.csv/.libsvmâ”‚                                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                       â”‚
â”‚           â”‚ (è¯»å–)                                                           â”‚
â”‚           â–¼                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                       â”‚
â”‚  â”‚  openmoa.datasets â”‚                                                       â”‚
â”‚  â”‚  ä¾‹: Magic04()    â”‚  è¿”å› Stream å¯¹è±¡                                     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  Schema: {d=10, classes=2}                            â”‚
â”‚           â”‚            instance.x = [v0, v1, ..., v9] (å›ºå®š10ç»´)            â”‚
â”‚           â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                        ShuffledStream                                 â”‚   â”‚
â”‚  â”‚  è¾“å…¥: base_stream (æœ‰åº)                                             â”‚   â”‚
â”‚  â”‚  å¤„ç†: å…¨é‡åŠ è½½ â†’ æ‰“ä¹±ç´¢å¼•                                             â”‚   â”‚
â”‚  â”‚  è¾“å‡º: æ‰“ä¹±åçš„ stream                                                 â”‚   â”‚
â”‚  â”‚  ç»´åº¦: ä¸å˜ (10ç»´)                                                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â”‚ (ä½œä¸º base_stream ä¼ å…¥)                                          â”‚
â”‚           â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     OpenFeatureStream (TDS)                           â”‚   â”‚
â”‚  â”‚  è¾“å…¥: shuffled_stream                                                â”‚   â”‚
â”‚  â”‚  å¤„ç†:                                                                â”‚   â”‚
â”‚  â”‚    t=0:   active=[0,1]        â†’ x=[v0,v1]        feature_indices=[0,1]â”‚   â”‚
â”‚  â”‚    t=100: active=[0,1,2,3]    â†’ x=[v0,v1,v2,v3]  feature_indices=[0,1,2,3]â”‚
â”‚  â”‚    t=500: active=[0,1,...,9]  â†’ x=å®Œæ•´10ç»´        feature_indices=[0..9]â”‚  â”‚
â”‚  â”‚  è¾“å‡º: å˜é•¿å‘é‡ + feature_indices å…ƒæ•°æ®                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                                                                 â”‚
â”‚           â”‚ next_instance() è¿”å›                                            â”‚
â”‚           â”‚                                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                     FOBOSClassifier                                   â”‚   â”‚
â”‚  â”‚  æ¥æ”¶: instance                                                       â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  _get_sparse_x(instance):                                            â”‚   â”‚
â”‚  â”‚    æ£€æµ‹ hasattr(instance, "feature_indices") â†’ True                  â”‚   â”‚
â”‚  â”‚    è¿”å› (instance.feature_indices, instance.x)                       â”‚   â”‚
â”‚  â”‚          å³ ([0,1,2,3], [v0,v1,v2,v3])                               â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  train():                                                             â”‚   â”‚
â”‚  â”‚    W[[0,1,2,3], 0] -= eta * grad * [v0,v1,v2,v3]                     â”‚   â”‚
â”‚  â”‚    (ç¨€ç–æ›´æ–°ï¼šåªä¿®æ”¹æ¶‰åŠçš„4è¡Œæƒé‡)                                      â”‚   â”‚
â”‚  â”‚                                                                       â”‚   â”‚
â”‚  â”‚  æƒé‡çŸ©é˜µ: W.shape = (10, 1)   â† å…¨å±€ç»´åº¦ï¼Œä¸éš t å˜åŒ–                â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®å˜æ¢è¿½è¸ªè¡¨

ä»¥ TDS æ¨¡å¼å¤„ç†ä¸€ä¸ªå…·ä½“å®ä¾‹ä¸ºä¾‹ï¼š

| é˜¶æ®µ | ä½ç½® | æ•°æ®å½¢æ€ | ç»´åº¦ |
|------|------|----------|------|
| åŸå§‹ | ç£ç›˜ `.libsvm` | `1 1:0.3 2:0.5 ... 10:0.9` | 10 |
| åŠ è½½ | `LibsvmStream` | `instance.x = [0.3, 0.5, ..., 0.9]` | 10 |
| æ‰“ä¹± | `ShuffledStream` | åŒä¸Šï¼ˆä»…é¡ºåºæ”¹å˜ï¼‰ | 10 |
| TDS t=50 | `OpenFeatureStream` | `x=[0.3,0.5], feature_indices=[0,1]` | 2 |
| TDS t=300 | `OpenFeatureStream` | `x=[0.3,0.5,0.6,0.7,0.8], fi=[0,1,2,3,4]` | 5 |
| TDS t=900 | `OpenFeatureStream` | `x=[å®Œæ•´10ç»´], fi=[0,1,...,9]` | 10 |
| å­¦ä¹ å™¨ | `FOBOSClassifier` | `indices, values = _get_sparse_x(inst)` | å˜é‡ |

---

## 5. ä¾èµ–å…³ç³»

### 5.1 å¤–éƒ¨åº“ä¾èµ–

| åº“ | ç‰ˆæœ¬è¦æ±‚ | ç”¨é€” |
|-----|----------|------|
| `numpy` | >= 1.20 | æ•°å€¼è®¡ç®—ã€æ•°ç»„æ“ä½œã€éšæœºæ•°ç”Ÿæˆ |
| `typing` | å†…ç½® (Python 3.9+) | ç±»å‹æ³¨è§£ (`Literal`, `Optional`, `List`) |

### 5.2 å†…éƒ¨æ¨¡å—ä¾èµ–

```
stream_wrapper.py
    â”‚
    â”œâ”€â”€ openmoa.stream.Stream        (åŸºç±»)
    â”‚   â””â”€â”€ _stream.py:296
    â”‚
    â”œâ”€â”€ openmoa.stream._stream.Schema (æµç»“æ„æè¿°)
    â”‚   â””â”€â”€ _stream.py:49
    â”‚
    â””â”€â”€ openmoa.instance
        â”œâ”€â”€ LabeledInstance          (åˆ†ç±»å®ä¾‹)
        â”‚   â””â”€â”€ instance.py:176
        â””â”€â”€ RegressionInstance       (å›å½’å®ä¾‹)
            â””â”€â”€ instance.py:230
```

### 5.3 è¢«ä¾èµ–å…³ç³»

```
stream_wrapper.py
    â”‚
    â”œâ”€â”€ openmoa.stream.__init__.py   (å¯¼å‡ºæ¥å£)
    â”‚   â””â”€â”€ å¯¼å‡º: OpenFeatureStream, TrapezoidalStream,
    â”‚            CapriciousStream, EvolvableStream, ShuffledStream
    â”‚
    â””â”€â”€ demo/*.py                    (17ä¸ªbenchmarkè„šæœ¬)
        â”œâ”€â”€ demo_fobos_benchmark_binary.py
        â”œâ”€â”€ demo_ovfm_benchmark_binary.py
        â””â”€â”€ ...
```

---

## 6. ç‰¹æ®Šæœºåˆ¶ä¸æŠ€æœ¯ç‚¹

### 6.1 ğŸ¨ è®¾è®¡æ¨¡å¼

#### 6.1.1 è£…é¥°å™¨æ¨¡å¼ (Decorator Pattern)

```python
# æ‰€æœ‰åŒ…è£…å™¨éƒ½æ¥å—ä¸€ä¸ª base_stream å‚æ•°
class OpenFeatureStream(Stream):
    def __init__(self, base_stream: Stream, ...):
        self.base_stream = base_stream

    def next_instance(self):
        base_instance = self.base_stream.next_instance()  # å§”æ‰˜ç»™åº•å±‚
        # ... è¿›è¡Œå¢å¼ºå¤„ç† ...
        return enhanced_instance
```

**ä¼˜ç‚¹**ï¼š
- åŒ…è£…å™¨å¯ä»¥ä»»æ„åµŒå¥—ï¼š`OpenFeatureStream(ShuffledStream(Magic04()))`
- éµå¾ªå¼€é—­åŸåˆ™ï¼šæ‰©å±•æ–°çš„æ¼”åŒ–æ¨¡å¼ä¸éœ€è¦ä¿®æ”¹ç°æœ‰ä»£ç 

#### 6.1.2 ç­–ç•¥æ¨¡å¼ (Strategy Pattern)

```python
# evolution_pattern å‚æ•°é€‰æ‹©ä¸åŒçš„ç®—æ³•ç­–ç•¥
if evolution_pattern == "tds":
    self._feature_offsets = self._generate_tds_offsets()
elif evolution_pattern == "eds":
    self._eds_partitions = self._generate_eds_partitions()
# ...
```

#### 6.1.3 æ¨¡æ¿æ–¹æ³•æ¨¡å¼ (Template Method Pattern)

æ‰€æœ‰åŒ…è£…å™¨å…±äº«ç›¸åŒçš„æ–¹æ³•ç­¾åï¼ˆç»§æ‰¿è‡ª `Stream` åŸºç±»ï¼‰ï¼š

```python
class Stream(ABC):
    @abstractmethod
    def next_instance(self) -> Instance: ...

    @abstractmethod
    def has_more_instances(self) -> bool: ...

    def get_schema(self) -> Schema: ...

    def restart(self): ...
```

### 6.2 ğŸ” å¯å¤ç°æ€§æœºåˆ¶

```python
# å…¨å±€éšæœºçŠ¶æ€
self._rng = np.random.RandomState(random_seed)

# æ—¶é—´æ­¥ç›¸å…³çš„å±€éƒ¨éšæœºçŠ¶æ€ï¼ˆç”¨äº CDS æ¨¡å¼ï¼‰
rng_t = np.random.RandomState(self.random_seed + t)
mask = rng_t.rand(self.d_max) > self.missing_ratio
```

> ğŸ’¡ ä½¿ç”¨ `np.random.RandomState` è€Œéå…¨å±€ `np.random`ï¼Œé¿å…å¤–éƒ¨ä»£ç çš„éšæœºè°ƒç”¨å½±å“å¯å¤ç°æ€§ã€‚

### 6.3 ğŸ›¡ï¸ é˜²å¾¡æ€§ç¼–ç¨‹

```python
# 1. å‚æ•°è¾¹ç•Œæ£€æŸ¥
if self.d_max > original_d:
    raise ValueError(f"d_max ({self.d_max}) cannot exceed original feature count ({original_d})")

if n_segments < 2:
    raise ValueError("n_segments must be >= 2 for EDS pattern")

# 2. ç©ºç»“æœä¿æŠ¤
indices = np.where(mask)[0]
if len(indices) == 0:
    indices = np.array([0])  # ä¿åº•ï¼šè‡³å°‘è¿”å›ä¸€ä¸ªç‰¹å¾

# 3. è¶Šç•Œä¿æŠ¤
valid_indices = active_indices[active_indices < len(x_full)]
if len(valid_indices) == 0:
    valid_indices = np.array([0])

# 4. å®‰å…¨çš„æ—¶é—´ç´¢å¼•è®¿é—®
t_idx = min(self._current_t, self.total_instances - 1)
```

### 6.4 âš¡ æ€§èƒ½ä¼˜åŒ–

#### 6.4.1 é¢„è®¡ç®— (Pre-computation)

```python
# åˆå§‹åŒ–æ—¶é¢„è®¡ç®—æ‰€æœ‰æ—¶é—´æ­¥çš„ç´¢å¼•ï¼Œé¿å…è¿è¡Œæ—¶é‡å¤è®¡ç®—
self._dimension_schedule = self._generate_dimension_schedule()
self._feature_indices_cache = self._generate_feature_indices()
```

**æ—¶é—´å¤æ‚åº¦å¯¹æ¯”**ï¼š

| æ–¹æ³• | åˆå§‹åŒ– | æ¯æ¬¡ next_instance |
|------|--------|-------------------|
| é¢„è®¡ç®— | O(T) | O(1) æŸ¥è¡¨ |
| åŠ¨æ€è®¡ç®— | O(1) | O(d_max) |

å¯¹äºé•¿æµï¼ˆT >> d_maxï¼‰ï¼Œé¢„è®¡ç®—æ›´ä¼˜ã€‚

#### 6.4.2 NumPy å‘é‡åŒ–

```python
# å‘é‡åŒ–å¸ƒå°”ç´¢å¼•ï¼Œè€Œé Python å¾ªç¯
mask = rng_t.rand(self.d_max) > self.missing_ratio
indices = np.where(mask)[0]

# å‘é‡åŒ–åˆ‡ç‰‡
x_subset = x_full[valid_indices]
```

### 6.5 ğŸ”§ åŠ¨æ€å±æ€§é™„åŠ 

```python
# ä¸ºå®ä¾‹åŠ¨æ€æ·»åŠ  feature_indices å±æ€§
new_instance.feature_indices = valid_indices
```

è¿™æ˜¯ Python çš„åŠ¨æ€ç‰¹æ€§ï¼Œæ— éœ€ä¿®æ”¹ `Instance` ç±»å®šä¹‰å³å¯æ‰©å±•å…¶åŠŸèƒ½ã€‚ä¸‹æ¸¸ä»£ç é€šè¿‡ `hasattr` æ£€æµ‹ï¼š

```python
if hasattr(instance, "feature_indices"):
    return instance.feature_indices, instance.x
```

---

## 7. æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®

### 7.1 ğŸ› å·²è¯†åˆ«é—®é¢˜

#### é—®é¢˜ 1ï¼šShuffledStream å†…å­˜æ¶ˆè€—

```python
# å½“å‰å®ç°ï¼šå…¨é‡åŠ è½½
while base_stream.has_more_instances():
    self._instances.append(base_stream.next_instance())
```

**é£é™©**ï¼šå¯¹äºå¤§æ•°æ®é›†ï¼ˆå¦‚ GB çº§ï¼‰ï¼Œä¼šå¯¼è‡´å†…å­˜æº¢å‡ºã€‚

**å»ºè®®æ”¹è¿›**ï¼š
```python
# æ–¹æ¡ˆ 1ï¼šä½¿ç”¨å†…å­˜æ˜ å°„æ–‡ä»¶ (Memory-Mapped File)
# æ–¹æ¡ˆ 2ï¼šåˆ†å—æ´—ç‰Œ (Chunk-based Shuffling)
# æ–¹æ¡ˆ 3ï¼šä½¿ç”¨ Reservoir Sampling è¿›è¡Œæµå¼æ´—ç‰Œ
```

#### é—®é¢˜ 2ï¼šCDS æ¨¡å¼çš„æç«¯æƒ…å†µ

```python
mask = rng_t.rand(self.d_max) > self.missing_ratio
indices = np.where(mask)[0]
if len(indices) == 0:
    indices = np.array([0])  # åªä¿ç•™ç‰¹å¾ 0
```

**é£é™©**ï¼šå½“ `missing_ratio` æ¥è¿‘ 1.0 æ—¶ï¼Œé¢‘ç¹è§¦å‘ä¿åº•æœºåˆ¶ï¼Œç‰¹å¾ 0 è¢«è¿‡åº¦å¼ºè°ƒã€‚

**å»ºè®®æ”¹è¿›**ï¼š
```python
if len(indices) == 0:
    # éšæœºé€‰æ‹©ä¸€ä¸ªç‰¹å¾ï¼Œè€Œéæ€»æ˜¯é€‰ 0
    indices = np.array([rng_t.randint(0, self.d_max)])
```

#### é—®é¢˜ 3ï¼šSchema ä¸ä¸€è‡´

```python
def get_schema(self) -> Schema:
    return self._schema  # è¿”å›åŸå§‹ Schemaï¼ˆd_max ç»´ï¼‰
```

**é£é™©**ï¼šå¯¹äº `OpenFeatureStream`ï¼Œè¿”å›çš„ Schema æè¿°çš„æ˜¯ d_max ç»´ç©ºé—´ï¼Œä½†å®é™…è¾“å‡ºçš„å‘é‡å¯èƒ½åªæœ‰ d_min ç»´ã€‚æŸäº›ä¾èµ– Schema çš„ä¸‹æ¸¸ä»£ç å¯èƒ½äº§ç”Ÿç»´åº¦ä¸åŒ¹é…é”™è¯¯ã€‚

**å»ºè®®æ”¹è¿›**ï¼š
```python
# æ–¹æ¡ˆ 1ï¼šæ–‡æ¡£æ˜ç¡®è¯´æ˜è¡Œä¸º
# æ–¹æ¡ˆ 2ï¼šåˆ›å»ºåŠ¨æ€ Schema æˆ–è¿”å› None è¡¨ç¤ºå¯å˜ç»´åº¦
```

### 7.2 ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### å»ºè®® 1ï¼šæƒ°æ€§è®¡ç®— (Lazy Evaluation)

```python
# å½“å‰ï¼šåˆå§‹åŒ–æ—¶é¢„è®¡ç®—æ‰€æœ‰ total_instances ä¸ªç´¢å¼•
# æ”¹è¿›ï¼šä½¿ç”¨ç”Ÿæˆå™¨æŒ‰éœ€è®¡ç®—
def _generate_feature_indices(self):
    for t in range(self.total_instances):
        yield self._compute_indices_for_t(t)
```

#### å»ºè®® 2ï¼šç¼“å­˜ä¼˜åŒ–

```python
# å¯¹äº EDS æ¨¡å¼ï¼Œåˆ†åŒºä¿¡æ¯å¯ä»¥ç”¨å…ƒç»„å­˜å‚¨ä»¥èŠ‚çœå†…å­˜
self._eds_partitions = tuple(np.sort(p) for p in partitions)
```

### 7.3 ğŸ” å¯è¯»æ€§æ”¹è¿›

#### å»ºè®® 1ï¼šæå–é­”æ³•æ•°å­—

```python
# å½“å‰
time_step = self.total_instances // 10  # ä¸ºä»€ä¹ˆæ˜¯ 10ï¼Ÿ

# æ”¹è¿›
TDS_NUM_BUCKETS = 10  # TDS æ¨¡å¼çš„é˜¶æ®µæ•°
time_step = self.total_instances // TDS_NUM_BUCKETS
```

#### å»ºè®® 2ï¼šç»Ÿä¸€æ–¹æ³•å‘½å

```python
# å½“å‰æ··ç”¨
_get_active_indices()   # OpenFeatureStream
_get_active_mask()      # EvolvableStream
_get_feature_mask()     # CapriciousStream

# å»ºè®®ç»Ÿä¸€ä¸º
_compute_active_features() â†’ (indices | mask)
```

---

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 ğŸš€ å¿«é€Ÿä¸Šæ‰‹

```python
from openmoa.datasets import Magic04
from openmoa.stream import ShuffledStream, OpenFeatureStream
from openmoa.classifier._fobos_classifier import FOBOSClassifier

# 1. åŠ è½½æ•°æ®é›†å¹¶æ‰“ä¹±
base = ShuffledStream(Magic04(), random_seed=42)
n_total = base.get_num_instances()  # 19020

# 2. åŒ…è£…ä¸º TDS æ¼”åŒ–æµ
stream = OpenFeatureStream(
    base_stream=base,
    evolution_pattern="tds",
    tds_mode="ordered",
    d_min=2,
    total_instances=n_total,
    random_seed=42
)

# 3. åˆå§‹åŒ–å­¦ä¹ å™¨
schema = stream.get_schema()
learner = FOBOSClassifier(
    schema=schema,
    alpha=1.0,
    lambda_=0.0001,
    regularization="l1"
)

# 4. åœ¨çº¿å­¦ä¹ å¾ªç¯
correct = 0
total = 0
while stream.has_more_instances():
    instance = stream.next_instance()

    # è§‚å¯Ÿç‰¹å¾æ¼”åŒ–
    print(f"t={total}: dim={len(instance.x)}, indices={instance.feature_indices}")

    # Test-Then-Train
    pred = learner.predict(instance)
    if pred == instance.y_index:
        correct += 1
    learner.train(instance)
    total += 1

print(f"Accuracy: {correct/total:.4f}")
```

### 8.2 ğŸ”„ CDS æ¨¡å¼ç¤ºä¾‹ï¼ˆéšæœºç¼ºå¤±ï¼‰

```python
stream = OpenFeatureStream(
    base_stream=ShuffledStream(Magic04()),
    evolution_pattern="cds",
    missing_ratio=0.4,  # 40% çš„ç‰¹å¾ç¼ºå¤±
    total_instances=19020,
    random_seed=42
)

# è§‚å¯Ÿç¼ºå¤±æ¨¡å¼
for i, inst in enumerate(stream):
    if i >= 5:
        break
    print(f"t={i}: present={inst.feature_indices}, missing={set(range(10)) - set(inst.feature_indices)}")
```

è¾“å‡ºç¤ºä¾‹ï¼š
```
t=0: present=[0,2,4,5,7,9], missing={1,3,6,8}
t=1: present=[1,2,3,6,8,9], missing={0,4,5,7}
t=2: present=[0,1,3,5,6,7,8], missing={2,4,9}
...
```

### 8.3 ğŸ“Š EDS æ¨¡å¼ç¤ºä¾‹ï¼ˆåˆ†æ®µæ¼”åŒ–ï¼‰

```python
stream = OpenFeatureStream(
    base_stream=ShuffledStream(Magic04()),
    evolution_pattern="eds",
    n_segments=3,      # 3ä¸ªåˆ†åŒº
    overlap_ratio=0.5, # é‡å æœŸ = 0.5 * ç¨³å®šæœŸ
    total_instances=1000,
    random_seed=42
)

# è¿½è¸ªé˜¶æ®µè½¬æ¢
stages = {}
for i, inst in enumerate(stream):
    key = tuple(inst.feature_indices)
    if key not in stages:
        stages[key] = i
        print(f"t={i}: New stage, features={key}")
```

### 8.4 ğŸ”€ ä¸ NaN æ–¹æ¡ˆå¯¹æ¯”

```python
from openmoa.stream import TrapezoidalStream

# å›ºå®šç»´åº¦ + NaN æ–¹æ¡ˆ
stream_nan = TrapezoidalStream(
    base_stream=ShuffledStream(Magic04()),
    evolution_mode="ordered",
    total_instances=1000
)

inst = stream_nan.next_instance()
print(f"Vector: {inst.x}")        # å®Œæ•´10ç»´ï¼Œéƒ¨åˆ†ä½ç½®æ˜¯ NaN
print(f"Has NaN: {np.isnan(inst.x).sum()}")  # ç»Ÿè®¡ NaN æ•°é‡
print(f"Has feature_indices: {hasattr(inst, 'feature_indices')}")  # False
```

---

## ğŸ“ é™„å½•

### A. æœ¯è¯­å¯¹ç…§è¡¨

| ä¸­æ–‡æœ¯è¯­ | è‹±æ–‡æœ¯è¯­ | ç¼©å†™ |
|----------|----------|------|
| æ•°æ®æµ | Data Stream | Stream |
| ç‰¹å¾ç©ºé—´ | Feature Space | - |
| ç‰¹å¾æ¼‚ç§» | Feature Drift | - |
| æ¦‚å¿µæ¼‚ç§» | Concept Drift | - |
| æ¢¯å½¢æ•°æ®æµ | Trapezoidal Data Stream | TDS |
| éšæœºç¼ºå¤±æ•°æ®æµ | Capricious Data Stream | CDS |
| åˆ†æ®µæ¼”åŒ–æ•°æ®æµ | Evolvable Data Stream | EDS |
| ç´¢å¼•åç§»é—®é¢˜ | Index Shift Problem | - |
| å…ˆæµ‹åè®­ | Test-Then-Train / Prequential | - |
| è£…é¥°å™¨æ¨¡å¼ | Decorator Pattern | - |
| ç¨€ç–æ„ŸçŸ¥ | Sparse-aware | - |

### B. ç›¸å…³æ–‡ä»¶å¿«é€Ÿç´¢å¼•

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| Stream åŸºç±» | `src/openmoa/stream/_stream.py:296` | æŠ½è±¡åŸºç±»å®šä¹‰ |
| Schema ç±» | `src/openmoa/stream/_stream.py:49` | æµç»“æ„æè¿° |
| Instance ç±» | `src/openmoa/instance.py:38` | æ•°æ®å®ä¾‹åŸºç±» |
| FOBOS åˆ†ç±»å™¨ | `src/openmoa/classifier/_fobos_classifier.py` | ç¨€ç–æ„ŸçŸ¥å­¦ä¹ å™¨ç¤ºä¾‹ |
| åŒ…å¯¼å‡º | `src/openmoa/stream/__init__.py` | å…¬å¼€æ¥å£ |
| Benchmark ç¤ºä¾‹ | `demo/demo_fobos_benchmark_binary.py` | å®Œæ•´ä½¿ç”¨ç¤ºä¾‹ |

---

> ğŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **æœ€åæ›´æ–°**: 2026-02-10
> **ä½œè€…**: Claude Code Analysis

