# ğŸ“š OpenMOA Instance æ¨¡å—æ·±åº¦åˆ†ææ–‡æ¡£

> **æ–‡ä»¶è·¯å¾„**: `src/openmoa/instance.py`
> **ç‰ˆæœ¬**: OpenMOA 0.0.1
> **åˆ†ææ—¥æœŸ**: 2026-02-11

---

## ğŸ“‹ ç›®å½•

1. [æ¦‚è§ˆä¸å®šä½](#1-æ¦‚è§ˆä¸å®šä½)
2. [ä»£ç ç»“æ„åˆ†è§£](#2-ä»£ç ç»“æ„åˆ†è§£)
3. [é€è¡Œ/é€å—è¯¦è§£](#3-é€è¡Œé€å—è¯¦è§£)
4. [æ•°æ®æµåˆ†æ](#4-æ•°æ®æµåˆ†æ)
5. [ä¾èµ–å…³ç³»](#5-ä¾èµ–å…³ç³»)
6. [ç‰¹æ®Šæœºåˆ¶ä¸æŠ€æœ¯ç‚¹](#6-ç‰¹æ®Šæœºåˆ¶ä¸æŠ€æœ¯ç‚¹)
7. [æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®](#7-æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®)
8. [ä½¿ç”¨ç¤ºä¾‹](#8-ä½¿ç”¨ç¤ºä¾‹)

---

## 1. æ¦‚è§ˆä¸å®šä½

### 1.1 ğŸ¯ æ–‡ä»¶çš„ä¸»è¦ç›®çš„å’ŒåŠŸèƒ½

`instance.py` æ˜¯ OpenMOA æ¡†æ¶çš„**æ•°æ®å®ä¾‹ï¼ˆData Instanceï¼‰æ ¸å¿ƒæ¨¡å—**ï¼Œå®šä¹‰äº†æ•°æ®æµä¸­å•ä¸ªæ•°æ®ç‚¹çš„æŠ½è±¡è¡¨ç¤ºã€‚å®ƒæ˜¯è¿æ¥**æ•°æ®æºï¼ˆStreamï¼‰** ä¸ **å­¦ä¹ å™¨ï¼ˆLearnerï¼‰** ä¹‹é—´çš„æ¡¥æ¢ã€‚

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- å®šä¹‰æ•°æ®å®ä¾‹çš„ç»Ÿä¸€æŠ½è±¡ï¼ˆç‰¹å¾å‘é‡ + ç›®æ ‡å˜é‡ï¼‰
- æä¾› **Python â†” Java (MOA)** åŒå‘äº’æ“ä½œèƒ½åŠ›
- æ”¯æŒåˆ†ç±»ä»»åŠ¡ï¼ˆ`LabeledInstance`ï¼‰å’Œå›å½’ä»»åŠ¡ï¼ˆ`RegressionInstance`ï¼‰
- å®ç°æƒ°æ€§æ±‚å€¼ï¼ˆLazy Evaluationï¼‰ä¼˜åŒ–æ€§èƒ½

### 1.2 ğŸ—ï¸ åœ¨æ•´ä¸ªé¡¹ç›®ä¸­çš„è§’è‰²

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        OpenMOA æ•°æ®æµæ¶æ„                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚  Data Sources   â”‚  ç£ç›˜æ–‡ä»¶ / MOAç”Ÿæˆå™¨ / NumPyæ•°ç»„                  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚            â”‚                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                                   â”‚
â”‚   â”‚     Stream      â”‚  æ•°æ®æµæŠ½è±¡å±‚                                      â”‚
â”‚   â”‚   (_stream.py)  â”‚  - ARFFStream, CSVStream, NumpyStream             â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                   â”‚
â”‚            â”‚ next_instance()                                            â”‚
â”‚            â”‚                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    Instance  â­ æœ¬æ–‡ä»¶                            â”‚   â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚  â”‚  Instance (åŸºç±»)                                          â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ .x           â†’ ç‰¹å¾å‘é‡ (NumPy ndarray)            â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ .schema      â†’ æµç»“æ„æè¿°                          â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    â””â”€â”€ .java_instance â†’ MOA Java å¯¹è±¡                     â”‚   â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚   â”‚  â”‚  LabeledInstance (åˆ†ç±»)                                   â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    â”œâ”€â”€ .y_index     â†’ ç±»åˆ«ç´¢å¼• (int: 0, 1, 2, ...)       â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    â””â”€â”€ .y_label     â†’ ç±»åˆ«æ ‡ç­¾ (str: "yes", "no", ...)   â”‚   â”‚   â”‚
â”‚   â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤   â”‚   â”‚
â”‚   â”‚  â”‚  RegressionInstance (å›å½’)                                â”‚   â”‚   â”‚
â”‚   â”‚  â”‚    â””â”€â”€ .y_value     â†’ ç›®æ ‡å€¼ (float: 17.949, ...)        â”‚   â”‚   â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚   â”‚  Python Learner â”‚     â”‚  MOA Learner   â”‚                            â”‚
â”‚   â”‚  (FOBOS, FTRL)  â”‚     â”‚  (HOT, NB)     â”‚                            â”‚
â”‚   â”‚  ä½¿ç”¨ .x, .y_*  â”‚     â”‚  ä½¿ç”¨ .java_*  â”‚                            â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 1.3 ğŸ”§ è§£å†³çš„å…·ä½“é—®é¢˜

| é—®é¢˜ | è§£å†³æ–¹æ¡ˆ |
|------|----------|
| **Python/Java äº’æ“ä½œ** | åŒå‘æƒ°æ€§è½¬æ¢ï¼šPython ndarray â†” MOA InstanceExample |
| **ä»»åŠ¡ç±»å‹å·®å¼‚** | ç»§æ‰¿ä½“ç³»ï¼šInstance â†’ LabeledInstance / RegressionInstance |
| **æ€§èƒ½ä¼˜åŒ–** | æƒ°æ€§æ±‚å€¼ï¼šä»…åœ¨è®¿é—®æ—¶æ‰è¿›è¡Œè½¬æ¢ |
| **ç±»å‹å®‰å…¨** | ç±»å‹åˆ«åï¼ˆFeatureVector, LabelIndex, TargetValueï¼‰+ ç±»å‹æ³¨è§£ |
| **å¾ªç¯å¯¼å…¥** | `TYPE_CHECKING` æ¡ä»¶å¯¼å…¥ |

---

## 2. ä»£ç ç»“æ„åˆ†è§£

### 2.1 ğŸ“¦ ç»„ä»¶æ¸…å•

#### å‡½æ•°

| å‡½æ•°å | è¡Œå· | å¯è§æ€§ | èŒè´£ |
|--------|------|--------|------|
| `_features_to_string` | 17-35 | Private | æ ¼å¼åŒ–ç‰¹å¾å‘é‡ç”¨äº `__repr__` |

#### ç±»

| ç±»å | è¡Œå· | ç»§æ‰¿è‡ª | èŒè´£ |
|------|------|--------|------|
| `Instance` | 38-163 | - | åŸºç±»ï¼šæ— æ ‡ç­¾çš„æ•°æ®å®ä¾‹ |
| `LabeledInstance` | 166-270 | `Instance` | åˆ†ç±»å®ä¾‹ï¼šå¸¦ç±»åˆ«æ ‡ç­¾ |
| `RegressionInstance` | 273-365 | `Instance` | å›å½’å®ä¾‹ï¼šå¸¦è¿ç»­ç›®æ ‡å€¼ |

### 2.2 ğŸ” æ–¹æ³•æ¸…å•ï¼ˆæŒ‰ç±»åˆ†ç»„ï¼‰

#### Instanceï¼ˆåŸºç±»ï¼‰

| æ–¹æ³•å | è¡Œå· | ç±»å‹ | èŒè´£ |
|--------|------|------|------|
| `__init__` | 47-69 | Constructor | åˆå§‹åŒ–å®ä¾‹ï¼ˆæ”¯æŒ Java/NumPy ä¸¤ç§è¾“å…¥ï¼‰ |
| `from_java_instance` | 71-75 | @classmethod | å·¥å‚æ–¹æ³•ï¼šä» Java å¯¹è±¡åˆ›å»º |
| `from_array` | 77-106 | @classmethod | å·¥å‚æ–¹æ³•ï¼šä» NumPy æ•°ç»„åˆ›å»º |
| `schema` | 108-111 | @property | è¿”å›æµç»“æ„æè¿° |
| `x` | 113-125 | @property | **æƒ°æ€§æ±‚å€¼**ï¼šè¿”å›ç‰¹å¾å‘é‡ |
| `_set_y` | 127-133 | Protected | è®¾ç½®ç›®æ ‡å˜é‡ï¼ˆå­ç±»è¦†ç›–ï¼‰ |
| `java_instance` | 135-155 | @property | **æƒ°æ€§æ±‚å€¼**ï¼šè¿”å› MOA Java å¯¹è±¡ |
| `__repr__` | 157-163 | Magic | å­—ç¬¦ä¸²è¡¨ç¤º |

#### LabeledInstance

| æ–¹æ³•å | è¡Œå· | ç±»å‹ | èŒè´£ |
|--------|------|------|------|
| `__init__` | 189-197 | Constructor | åˆå§‹åŒ–åˆ†ç±»å®ä¾‹ |
| `from_array` | 199-237 | @classmethod | å·¥å‚æ–¹æ³•ï¼šä»æ•°ç»„+æ ‡ç­¾ç´¢å¼•åˆ›å»º |
| `y_label` | 239-242 | @property | è¿”å›ç±»åˆ«æ ‡ç­¾å­—ç¬¦ä¸² |
| `y_index` | 244-256 | @property | **æƒ°æ€§æ±‚å€¼**ï¼šè¿”å›ç±»åˆ«ç´¢å¼• |
| `_set_y` | 258-260 | Protected | è¦†ç›–ï¼šè®¾ç½®åˆ†ç±»æ ‡ç­¾ |
| `__repr__` | 262-270 | Magic | å­—ç¬¦ä¸²è¡¨ç¤ºï¼ˆå«æ ‡ç­¾ä¿¡æ¯ï¼‰ |

#### RegressionInstance

| æ–¹æ³•å | è¡Œå· | ç±»å‹ | èŒè´£ |
|--------|------|------|------|
| `__init__` | 293-301 | Constructor | åˆå§‹åŒ–å›å½’å®ä¾‹ |
| `from_array` | 303-340 | @classmethod | å·¥å‚æ–¹æ³•ï¼šä»æ•°ç»„+ç›®æ ‡å€¼åˆ›å»º |
| `y_value` | 342-351 | @property | **æƒ°æ€§æ±‚å€¼**ï¼šè¿”å›ç›®æ ‡å€¼ |
| `__repr__` | 353-360 | Magic | å­—ç¬¦ä¸²è¡¨ç¤ºï¼ˆå«ç›®æ ‡å€¼ï¼‰ |
| `_set_y` | 362-364 | Protected | è¦†ç›–ï¼šè®¾ç½®å›å½’ç›®æ ‡å€¼ |

### 2.3 ğŸ”— ç±»ç»§æ‰¿ä¸è°ƒç”¨å…³ç³»

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    Instance     â”‚  åŸºç±»
                    â”‚                 â”‚
                    â”‚ + schema        â”‚
                    â”‚ + x             â”‚  æƒ°æ€§ï¼š_x â†” _java_instance
                    â”‚ + java_instance â”‚
                    â”‚ + _set_y()      â”‚  æ¨¡æ¿æ–¹æ³•ï¼ˆå­ç±»è¦†ç›–ï¼‰
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                 â”‚
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LabeledInstance â”‚             â”‚ RegressionInstanceâ”‚
   â”‚                 â”‚             â”‚                   â”‚
   â”‚ + y_index       â”‚             â”‚ + y_value         â”‚
   â”‚ + y_label       â”‚             â”‚                   â”‚
   â”‚ + _set_y() è¦†ç›– â”‚             â”‚ + _set_y() è¦†ç›–   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è°ƒç”¨é“¾ç¤ºä¾‹**ï¼š

```
Stream.next_instance()
    â”‚
    â”œâ”€â”€ æƒ…å†µ1ï¼šæ¥è‡ª MOA Java æµ
    â”‚   â””â”€â”€ LabeledInstance(schema, java_instance)
    â”‚       â””â”€â”€ Instance.__init__(schema, java_instance)
    â”‚           â””â”€â”€ self._java_instance = java_instance
    â”‚
    â”œâ”€â”€ æƒ…å†µ2ï¼šæ¥è‡ª NumpyStream
    â”‚   â””â”€â”€ LabeledInstance.from_array(schema, x, y_index)
    â”‚       â””â”€â”€ LabeledInstance(schema, (x, y_index))
    â”‚           â””â”€â”€ Instance.__init__(schema, x)
    â”‚               â””â”€â”€ self._x = x
    â”‚
    â””â”€â”€ åç»­è®¿é—®:
        â”œâ”€â”€ instance.x (é¦–æ¬¡è®¿é—®)
        â”‚   â””â”€â”€ if _x is None: ä» _java_instance æå–
        â”‚
        â””â”€â”€ instance.java_instance (é¦–æ¬¡è®¿é—®)
            â””â”€â”€ if _java_instance is None: ä» _x æ„å»º
```

---

## 3. é€è¡Œ/é€å—è¯¦è§£

### 3.1 ğŸ”§ å¯¼å…¥ä¸ç±»å‹å£°æ˜ (Lines 1-14)

```python
from typing import TYPE_CHECKING                    # æ¡ä»¶å¯¼å…¥æ ‡è®°

import numpy as np                                  # æ•°å€¼è®¡ç®—
from com.yahoo.labs.samoa.instances import DenseInstance  # MOA å¯†é›†å®ä¾‹ç±»
from moa.core import InstanceExample                # MOA å®ä¾‹åŒ…è£…å™¨
from typing import Optional, Union, Tuple           # ç±»å‹æ³¨è§£
from jpype import JArray, JDouble                   # Java æ•°ç»„æ¡¥æ¥

from openmoa.type_alias import FeatureVector, Label, LabelIndex, TargetValue

# ğŸ”‘ å…³é”®æŠ€æœ¯ï¼šé¿å…å¾ªç¯å¯¼å…¥
if TYPE_CHECKING:
    from openmoa.stream import Schema
```

**`TYPE_CHECKING` è¯¦è§£**ï¼š

```python
# é—®é¢˜ï¼šinstance.py éœ€è¦ Schema ç±»å‹ï¼ŒSchema å®šä¹‰åœ¨ _stream.py
#       _stream.py åˆéœ€è¦ Instance ç±»å‹
#       ç›´æ¥å¯¼å…¥ä¼šå½¢æˆå¾ªç¯ä¾èµ–

# è§£å†³æ–¹æ¡ˆï¼š
if TYPE_CHECKING:  # ä»…åœ¨ç±»å‹æ£€æŸ¥å™¨ï¼ˆå¦‚ mypyï¼‰è¿è¡Œæ—¶ä¸º True
    from openmoa.stream import Schema  # è¿è¡Œæ—¶ä¸æ‰§è¡Œæ­¤å¯¼å…¥

# ä½¿ç”¨æ—¶ç”¨å­—ç¬¦ä¸²å¼•ç”¨ï¼ˆForward Referenceï¼‰
def __init__(self, schema: "Schema", ...):  # "Schema" è€Œé Schema
```

---

### 3.2 ğŸ“ è¾…åŠ©å‡½æ•° (Lines 17-35)

```python
def _features_to_string(
    x: np.ndarray,
    prefix: str = "\n    x=",
    suffix: str = ","
) -> str:
    """æ ¼å¼åŒ–ç‰¹å¾å‘é‡ä¸ºå¯è¯»å­—ç¬¦ä¸²"""
    return (
        prefix
        + np.array2string(
            x,
            max_line_width=80,      # æ¯è¡Œæœ€å¤§80å­—ç¬¦
            threshold=10,            # è¶…è¿‡10ä¸ªå…ƒç´ æ—¶çœç•¥ä¸­é—´éƒ¨åˆ†
            prefix=prefix,           # ç”¨äºè®¡ç®—ç¼©è¿›
            suffix=suffix,
            precision=3,             # ä¿ç•™3ä½å°æ•°
        )
        + suffix
    )
```

**è¾“å‡ºç¤ºä¾‹**ï¼š

```python
# çŸ­å‘é‡
x = np.array([0.1, 0.2, 0.3])
# â†’ "\n    x=[0.1 0.2 0.3],"

# é•¿å‘é‡ï¼ˆè¶…è¿‡thresholdï¼‰
x = np.array([0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0, 1.1, 1.2])
# â†’ "\n    x=[0.1 0.2 0.3 ... 1.  1.1 1.2],"
```

---

### 3.3 ğŸ“ Instance åŸºç±»è¯¦è§£ (Lines 38-163)

#### 3.3.1 æ„é€ å‡½æ•° (Lines 47-69)

```python
def __init__(
    self,
    schema: "Schema",                                    # æµç»“æ„æè¿°
    instance: Union[InstanceExample, FeatureVector]      # Javaå¯¹è±¡ æˆ– NumPyæ•°ç»„
) -> None:
    self._schema: "Schema" = schema
    self._java_instance: Optional[InstanceExample] = None  # æƒ°æ€§ç¼“å­˜
    self._x: Optional[FeatureVector] = None                # æƒ°æ€§ç¼“å­˜

    # æ ¹æ®è¾“å…¥ç±»å‹åˆå§‹åŒ–å¯¹åº”çš„ç¼“å­˜
    if isinstance(instance, InstanceExample):
        self._java_instance = instance   # æ¥è‡ª MOA æµ
    elif isinstance(instance, np.ndarray):
        self._x = instance               # æ¥è‡ª Python æµ
    else:
        raise ValueError(f"Given instance type unsupported: {type(instance)}")
```

**å†…éƒ¨çŠ¶æ€æ¨¡å‹**ï¼š

```
åˆå§‹åŒ–åçš„çŠ¶æ€ï¼š

æƒ…å†µ1ï¼šæ¥è‡ª Java
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _schema = Schema(...)           â”‚
â”‚ _java_instance = <MOAå¯¹è±¡>      â”‚  âœ… å·²å¡«å……
â”‚ _x = None                       â”‚  âŒ ç©ºï¼ˆæƒ°æ€§ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æƒ…å†µ2ï¼šæ¥è‡ª Python
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _schema = Schema(...)           â”‚
â”‚ _java_instance = None           â”‚  âŒ ç©ºï¼ˆæƒ°æ€§ï¼‰
â”‚ _x = array([0.1, 0.2, ...])    â”‚  âœ… å·²å¡«å……
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.2 ç‰¹å¾å‘é‡å±æ€§ (Lines 113-125) â­ æ ¸å¿ƒ

```python
@property
def x(self) -> FeatureVector:
    """è¿”å›ç‰¹å¾å‘é‡ï¼Œæƒ°æ€§æ±‚å€¼"""

    # ä¼˜å…ˆçº§1ï¼šPython åŸç”Ÿæ•°æ®
    if self._x is not None:
        return self._x

    # ä¼˜å…ˆçº§2ï¼šä» Java å®ä¾‹æå–
    elif self._java_instance is not None:
        moa_instance = self.java_instance.getData()  # è·å– MOA Instance
        self._x = np.empty(moa_instance.numInputAttributes())

        # é€ä¸ªæå–ç‰¹å¾å€¼ï¼ˆJava â†’ Pythonï¼‰
        for i in range(0, moa_instance.numInputAttributes()):
            self._x[i] = moa_instance.value(i)

        return self._x

    else:
        raise ValueError("Instance has no feature vector")
```

**æƒ°æ€§æ±‚å€¼æµç¨‹å›¾**ï¼š

```
é¦–æ¬¡è°ƒç”¨ instance.x:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if _x is not None:         â†’ ç›´æ¥è¿”å›ï¼ˆO(1)ï¼‰       â”‚
â”‚     return _x                                       â”‚
â”‚                                                     â”‚
â”‚ elif _java_instance:                                â”‚
â”‚     moa_inst = _java_instance.getData()            â”‚
â”‚     _x = np.empty(d)                               â”‚
â”‚     for i in range(d):      â†’ é€ä¸ªæå–ï¼ˆO(d)ï¼‰     â”‚
â”‚         _x[i] = moa_inst.value(i)                  â”‚
â”‚     return _x               â†’ ç¼“å­˜åè¿”å›            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åç»­è°ƒç”¨ instance.x:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ if _x is not None:         â†’ ç›´æ¥è¿”å›ç¼“å­˜ï¼ˆO(1)ï¼‰  â”‚
â”‚     return _x                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.3 Java å®ä¾‹å±æ€§ (Lines 135-155) â­ æ ¸å¿ƒ

```python
@property
def java_instance(self) -> InstanceExample:
    """è¿”å› MOA Java å¯¹è±¡ï¼Œæƒ°æ€§æ±‚å€¼"""

    # ä¼˜å…ˆçº§1ï¼šå·²æœ‰ Java å®ä¾‹
    if self._java_instance is not None:
        return self._java_instance

    # ä¼˜å…ˆçº§2ï¼šä» Python æ•°æ®æ„å»º
    elif self._x is not None:
        assert self._x.ndim == 1, "Feature vector must be 1D."

        # 1ï¸âƒ£ åˆ†é… Java double æ•°ç»„ï¼ˆç‰¹å¾æ•° + 1 ç”¨äºç›®æ ‡å˜é‡ï¼‰
        jx = JArray(JDouble)(len(self.x) + 1)

        # 2ï¸âƒ£ å¤åˆ¶ç‰¹å¾å€¼åˆ° Java æ•°ç»„
        jx[: len(self.x)] = self.x

        # 3ï¸âƒ£ åˆ›å»º MOA DenseInstanceï¼ˆæƒé‡=1.0ï¼‰
        instance = DenseInstance(1.0, jx)

        # 4ï¸âƒ£ å…³è”æ•°æ®é›†å¤´ä¿¡æ¯ï¼ˆSchemaï¼‰
        instance.setDataset(self.schema.get_moa_header())

        # 5ï¸âƒ£ è®¾ç½®ç›®æ ‡å˜é‡ï¼ˆç”± _set_y å¤„ç†ï¼‰
        self._java_instance = InstanceExample(self._set_y(instance))

        return self._java_instance
```

**Python â†’ Java è½¬æ¢è¯¦è§£**ï¼š

```
Python çŠ¶æ€:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ _x = np.array([0.1, 0.2, 0.3])         â”‚  3ä¸ªç‰¹å¾
â”‚ _schema = Schema(3 features, 2 classes) â”‚
â”‚ _y_index = 1 (å¦‚æœæ˜¯ LabeledInstance)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ JArray(JDouble)(4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ jx = [0.1, 0.2, 0.3, ?]                â”‚  4ä¸ªä½ç½®ï¼ˆç‰¹å¾+ç›®æ ‡ï¼‰
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ jx[:3] = self.x
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ jx = [0.1, 0.2, 0.3, ?]                â”‚  å‰3ä¸ªä½ç½®å¡«å……
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ DenseInstance(1.0, jx)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MOA DenseInstance                       â”‚
â”‚   weight = 1.0                          â”‚
â”‚   values = [0.1, 0.2, 0.3, ?]          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ setDataset(moa_header)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MOA DenseInstance (å·²å…³è” Schema)        â”‚
â”‚   knows: 3 input attrs, 1 class attr   â”‚
â”‚   knows: class values = ["yes", "no"]  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ _set_y(instance) [å­ç±»è¦†ç›–]
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LabeledInstance._set_y:                 â”‚
â”‚   instance.setClassValue(1)            â”‚
â”‚   â†’ values = [0.1, 0.2, 0.3, 1.0]     â”‚
â”‚                                         â”‚
â”‚ Instance._set_y (åŸºç±»):                 â”‚
â”‚   instance.setMissing(classIndex)      â”‚
â”‚   â†’ values = [0.1, 0.2, 0.3, NaN]     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼ InstanceExample(instance)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ MOA InstanceExample (æœ€ç»ˆåŒ…è£…)           â”‚
â”‚   å¯ä¼ å…¥ MOA å­¦ä¹ å™¨ä½¿ç”¨                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 3.3.4 æ¨¡æ¿æ–¹æ³• _set_y (Lines 127-133)

```python
def _set_y(self, instance: DenseInstance) -> DenseInstance:
    """åŸºç±»é»˜è®¤è¡Œä¸ºï¼šå°†ç›®æ ‡å˜é‡è®¾ä¸ºç¼ºå¤±"""
    instance.setMissing(instance.classIndex())  # æ ‡è®°ä¸º missing
    return instance
```

> ğŸ”‘ **è®¾è®¡æ¨¡å¼ï¼šæ¨¡æ¿æ–¹æ³•ï¼ˆTemplate Methodï¼‰**
>
> åŸºç±»å®šä¹‰ç®—æ³•éª¨æ¶ï¼ˆ`java_instance` å±æ€§ï¼‰ï¼Œä½†å°†ç›®æ ‡å˜é‡çš„è®¾ç½®å§”æ‰˜ç»™å­ç±»è¦†ç›–çš„ `_set_y` æ–¹æ³•ã€‚

---

### 3.4 ğŸ“ LabeledInstance è¯¦è§£ (Lines 166-270)

#### 3.4.1 æ„é€ å‡½æ•° (Lines 189-197)

```python
def __init__(
    self,
    schema: "Schema",
    instance: Union[InstanceExample, Tuple[FeatureVector, LabelIndex]],  # æ”¯æŒå…ƒç»„
) -> None:
    self._y_index: Optional[LabelIndex] = None

    # å¦‚æœè¾“å…¥æ˜¯ (x, y_index) å…ƒç»„ï¼Œè§£åŒ…
    if isinstance(instance, tuple):
        instance, self._y_index = instance  # instance å˜ä¸º xï¼Œself._y_index è¢«èµ‹å€¼

    super().__init__(schema, instance)
```

**è¾“å…¥æ ¼å¼å¯¹æ¯”**ï¼š

| è¾“å…¥ç±»å‹ | ç¤ºä¾‹ | æ¥æº |
|----------|------|------|
| `InstanceExample` | `<MOA Javaå¯¹è±¡>` | MOA æµ (ARFFStream) |
| `Tuple[ndarray, int]` | `(np.array([0.1, 0.2]), 1)` | Python æµ (NumpyStream) |

#### 3.4.2 å·¥å‚æ–¹æ³• from_array (Lines 199-237)

```python
@classmethod
def from_array(
    cls,
    schema: "Schema",
    x: FeatureVector,
    y_index: LabelIndex
) -> "LabeledInstance":
    """ä» NumPy æ•°ç»„å’Œç±»åˆ«ç´¢å¼•åˆ›å»ºå®ä¾‹"""
    return cls(schema, (x, int(y_index)))  # å°è£…ä¸ºå…ƒç»„ä¼ å…¥æ„é€ å‡½æ•°
```

> ğŸ’¡ **ä¸ºä»€ä¹ˆç”¨å·¥å‚æ–¹æ³•è€Œä¸æ˜¯ç›´æ¥æ„é€ ï¼Ÿ**
>
> - æä¾›æ›´æ¸…æ™°çš„ APIï¼š`from_array(schema, x, y_index)` æ¯” `LabeledInstance(schema, (x, y_index))` æ›´æ˜“è¯»
> - å¯ä»¥åœ¨å·¥å‚æ–¹æ³•ä¸­æ·»åŠ éªŒè¯é€»è¾‘
> - éµå¾ª Python æƒ¯ä¾‹ï¼ˆå¦‚ `datetime.fromtimestamp()`ï¼‰

#### 3.4.3 æ ‡ç­¾å±æ€§ (Lines 239-256)

```python
@property
def y_label(self) -> Label:
    """è¿”å›ç±»åˆ«æ ‡ç­¾å­—ç¬¦ä¸²"""
    return self.schema.get_value_for_index(self.y_index)
    # ä¾‹ï¼šy_index=0 â†’ schemaæŸ¥è¡¨ â†’ "yes"

@property
def y_index(self) -> LabelIndex:
    """è¿”å›ç±»åˆ«ç´¢å¼•ï¼ˆæƒ°æ€§æ±‚å€¼ï¼‰"""
    if self._y_index is not None:
        return self._y_index
    elif self._java_instance is not None:
        # ä» Java å®ä¾‹æå–
        self._y_index = int(self.java_instance.getData().classValue())
        return self._y_index
    else:
        raise ValueError(f"{self.__class__.__name__} must have a y_index.")
```

**y_index vs y_label å¯¹æ¯”**ï¼š

| å±æ€§ | ç±»å‹ | ç¤ºä¾‹ | ç”¨é€” |
|------|------|------|------|
| `y_index` | `int` | `0`, `1`, `2` | ç®—æ³•å†…éƒ¨è®¡ç®—ã€æ•°ç»„ç´¢å¼• |
| `y_label` | `str` | `"yes"`, `"no"`, `"spam"` | äººç±»å¯è¯»ã€æ—¥å¿—è¾“å‡º |

#### 3.4.4 è¦†ç›– _set_y (Lines 258-260)

```python
def _set_y(self, instance: DenseInstance) -> DenseInstance:
    """è¦†ç›–ï¼šè®¾ç½®åˆ†ç±»æ ‡ç­¾"""
    instance.setClassValue(self.y_index)  # è®¾ç½®ä¸ºç±»åˆ«ç´¢å¼•
    return instance
```

---

### 3.5 ğŸ“ RegressionInstance è¯¦è§£ (Lines 273-365)

ç»“æ„ä¸ `LabeledInstance` ç±»ä¼¼ï¼Œä¸»è¦åŒºåˆ«ï¼š

| å¯¹æ¯”é¡¹ | LabeledInstance | RegressionInstance |
|--------|-----------------|-------------------|
| ç›®æ ‡å˜é‡ | `y_index: int` (ç¦»æ•£) | `y_value: float` (è¿ç»­) |
| é¢å¤–å±æ€§ | `y_label: str` | æ—  |
| _set_y | `setClassValue(y_index)` | `setClassValue(y_value)` |

```python
@property
def y_value(self) -> TargetValue:
    """è¿”å›å›å½’ç›®æ ‡å€¼ï¼ˆæƒ°æ€§æ±‚å€¼ï¼‰"""
    if self._y_value is not None:
        return self._y_value
    elif self._java_instance is not None:
        self._y_value = self.java_instance.getData().classValue()  # æµ®ç‚¹æ•°
        return self._y_value
    else:
        raise ValueError(f"{self.__class__.__name__} must have a y_value.")
```

---

## 4. æ•°æ®æµåˆ†æ

### 4.1 æ•°æ®æ¥æº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®æ¥æºåˆ†ç±»                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1ï¸âƒ£ MOA Java æµ (ARFFStream, MOAStream)                          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ java_stream.nextInstance()                              â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ InstanceExample (Java å¯¹è±¡)                             â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ LabeledInstance(schema, java_instance)                  â”‚  â”‚
â”‚     â”‚     â†’ _java_instance = java_instance                   â”‚  â”‚
â”‚     â”‚     â†’ _x = None (æƒ°æ€§)                                  â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  2ï¸âƒ£ Python æµ (NumpyStream, CSVStream)                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ python_stream.next_instance()                           â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ (x: ndarray, y_index: int)                             â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ LabeledInstance.from_array(schema, x, y_index)          â”‚  â”‚
â”‚     â”‚     â†’ _x = x                                            â”‚  â”‚
â”‚     â”‚     â†’ _y_index = y_index                                â”‚  â”‚
â”‚     â”‚     â†’ _java_instance = None (æƒ°æ€§)                      â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  3ï¸âƒ£ Stream Wrapper (OpenFeatureStream)                           â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ wrapper.next_instance()                                 â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ base_instance = base_stream.next_instance()            â”‚  â”‚
â”‚     â”‚ x_subset = base_instance.x[active_indices]             â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ LabeledInstance.from_array(schema, x_subset, y_index)   â”‚  â”‚
â”‚     â”‚ new_instance.feature_indices = active_indices          â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.2 æ•°æ®æ¶ˆè´¹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       æ•°æ®æ¶ˆè´¹è€…åˆ†ç±»                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  1ï¸âƒ£ Python å­¦ä¹ å™¨ (FOBOSClassifier, FTRLClassifier, ...)         â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ learner.train(instance)                                 â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ x = instance.x              # è®¿é—®ç‰¹å¾å‘é‡              â”‚  â”‚
â”‚     â”‚ y = instance.y_index        # è®¿é—®æ ‡ç­¾                  â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ # çº¯ NumPy è®¡ç®—ï¼Œæ— éœ€ Java                              â”‚  â”‚
â”‚     â”‚ W[indices] -= eta * grad * values                      â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  2ï¸âƒ£ MOA å­¦ä¹ å™¨ (HoeffdingTree, NaiveBayes, ...)                  â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ learner.train(instance)                                 â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ java_inst = instance.java_instance  # è§¦å‘æƒ°æ€§è½¬æ¢      â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ moa_learner.trainOnInstance(java_inst)  # ä¼ ç»™ Java    â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â”‚  3ï¸âƒ£ è¯„ä¼°å™¨ (ClassificationEvaluator, ...)                        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚     â”‚ evaluator.update(true_label, prediction)                â”‚  â”‚
â”‚     â”‚     â†“                                                   â”‚  â”‚
â”‚     â”‚ true_label = instance.y_index                          â”‚  â”‚
â”‚     â”‚ # ä»…è®¿é—®æ ‡ç­¾ï¼Œä¸éœ€è¦å®Œæ•´å®ä¾‹                            â”‚  â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 4.3 æƒ°æ€§æ±‚å€¼çš„æ€§èƒ½ä¼˜åŠ¿

```
åœºæ™¯ï¼šPython å­¦ä¹ å™¨å¤„ç†æ¥è‡ª MOA æµçš„æ•°æ®

æ— æƒ°æ€§æ±‚å€¼ï¼ˆå‡è®¾ç«‹å³è½¬æ¢ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for instance in moa_stream:    # æ¯æ¬¡è¿­ä»£                    â”‚
â”‚     x = java_to_numpy(inst)    # O(d) è½¬æ¢ â† ç«‹å³æ‰§è¡Œ      â”‚
â”‚     java = numpy_to_java(x)    # O(d) è½¬æ¢ â† ä¹Ÿç«‹å³æ‰§è¡Œ    â”‚
â”‚     learner.train(instance)    # åªç”¨ xï¼Œjava è¢«æµªè´¹ï¼      â”‚
â”‚                                                             â”‚
â”‚ æ€»è®¡ï¼š2 * O(d) * n æ¬¡è½¬æ¢                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æœ‰æƒ°æ€§æ±‚å€¼ï¼ˆå½“å‰å®ç°ï¼‰:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ for instance in moa_stream:    # æ¯æ¬¡è¿­ä»£                    â”‚
â”‚     # _java_instance å·²å¡«å……ï¼Œ_x = None                      â”‚
â”‚     learner.train(instance)                                 â”‚
â”‚         x = instance.x         # é¦–æ¬¡è®¿é—®æ—¶æ‰è½¬æ¢ O(d)     â”‚
â”‚         # _java_instance ä»æœªè¢«è®¿é—®ï¼Œæ— éœ€åå‘è½¬æ¢          â”‚
â”‚                                                             â”‚
â”‚ æ€»è®¡ï¼šO(d) * n æ¬¡è½¬æ¢ï¼ˆå‡å°‘ 50%ï¼‰                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. ä¾èµ–å…³ç³»

### 5.1 å¤–éƒ¨åº“ä¾èµ–

| åº“ | å¯¼å…¥è¯­å¥ | ç”¨é€” |
|-----|----------|------|
| `numpy` | `import numpy as np` | ç‰¹å¾å‘é‡å­˜å‚¨ã€æ•°ç»„æ“ä½œ |
| `jpype` | `from jpype import JArray, JDouble` | Python-Java æ•°ç»„æ¡¥æ¥ |
| `typing` | `from typing import ...` | ç±»å‹æ³¨è§£ |

### 5.2 MOA Java ä¾èµ–ï¼ˆé€šè¿‡ JPypeï¼‰

| Java ç±» | å¯¼å…¥è¯­å¥ | ç”¨é€” |
|---------|----------|------|
| `DenseInstance` | `from com.yahoo.labs.samoa.instances import DenseInstance` | MOA å¯†é›†æ•°æ®å®ä¾‹ |
| `InstanceExample` | `from moa.core import InstanceExample` | MOA å®ä¾‹åŒ…è£…å™¨ |

### 5.3 å†…éƒ¨æ¨¡å—ä¾èµ–

```
instance.py
    â”‚
    â”œâ”€â”€ openmoa.type_alias
    â”‚   â”œâ”€â”€ FeatureVector  = NDArray[double]
    â”‚   â”œâ”€â”€ Label          = str
    â”‚   â”œâ”€â”€ LabelIndex     = int
    â”‚   â””â”€â”€ TargetValue    = double
    â”‚
    â””â”€â”€ openmoa.stream.Schema (ä»…ç±»å‹æ³¨è§£ï¼Œè¿è¡Œæ—¶ä¸å¯¼å…¥)
```

### 5.4 è¢«ä¾èµ–å…³ç³»ï¼ˆ30ä¸ªæ–‡ä»¶å¼•ç”¨ï¼‰

```
instance.py
    â”‚
    â”œâ”€â”€ openmoa.stream.*          (æµæ¨¡å—)
    â”‚   â”œâ”€â”€ _stream.py            (åˆ›å»ºå®ä¾‹)
    â”‚   â”œâ”€â”€ stream_wrapper.py     (åŒ…è£…å®ä¾‹)
    â”‚   â””â”€â”€ torch.py              (PyTorch æµ)
    â”‚
    â”œâ”€â”€ openmoa.classifier.*      (åˆ†ç±»å™¨)
    â”‚   â”œâ”€â”€ _fobos_classifier.py
    â”‚   â”œâ”€â”€ _ftrl_classifier.py
    â”‚   â””â”€â”€ ... (12ä¸ªåˆ†ç±»å™¨)
    â”‚
    â”œâ”€â”€ openmoa.regressor.*       (å›å½’å™¨)
    â”‚   â”œâ”€â”€ _fesl_regressor.py
    â”‚   â””â”€â”€ _oasf_regressor.py
    â”‚
    â”œâ”€â”€ openmoa.base.*            (åŸºç±»)
    â”‚   â”œâ”€â”€ _classifier.py
    â”‚   â””â”€â”€ _regressor.py
    â”‚
    â””â”€â”€ openmoa.evaluation.*      (è¯„ä¼°)
        â””â”€â”€ evaluation.py
```

---

## 6. ç‰¹æ®Šæœºåˆ¶ä¸æŠ€æœ¯ç‚¹

### 6.1 ğŸ¨ è®¾è®¡æ¨¡å¼

#### 6.1.1 æƒ°æ€§æ±‚å€¼æ¨¡å¼ï¼ˆLazy Evaluationï¼‰

```python
@property
def x(self) -> FeatureVector:
    if self._x is not None:      # ç¼“å­˜å‘½ä¸­
        return self._x
    elif self._java_instance is not None:
        self._x = self._extract_from_java()  # é¦–æ¬¡è®¿é—®æ—¶è®¡ç®—
        return self._x
```

**ä¼˜ç‚¹**ï¼š
- é¿å…ä¸å¿…è¦çš„è®¡ç®—ï¼ˆå¦‚æœä»ä¸è®¿é—® `.x`ï¼Œå°±ä¸æ‰§è¡Œè½¬æ¢ï¼‰
- é€æ˜ç¼“å­˜ï¼ˆè°ƒç”¨è€…æ— éœ€å…³å¿ƒæ˜¯å¦å·²è½¬æ¢ï¼‰

#### 6.1.2 æ¨¡æ¿æ–¹æ³•æ¨¡å¼ï¼ˆTemplate Methodï¼‰

```python
# åŸºç±»å®šä¹‰ç®—æ³•éª¨æ¶
class Instance:
    @property
    def java_instance(self):
        # ...
        self._java_instance = InstanceExample(self._set_y(instance))  # é’©å­
        # ...

    def _set_y(self, instance):  # é»˜è®¤å®ç°
        instance.setMissing(instance.classIndex())
        return instance

# å­ç±»è¦†ç›–é’©å­æ–¹æ³•
class LabeledInstance(Instance):
    def _set_y(self, instance):  # è¦†ç›–
        instance.setClassValue(self.y_index)
        return instance
```

#### 6.1.3 å·¥å‚æ–¹æ³•æ¨¡å¼ï¼ˆFactory Methodï¼‰

```python
@classmethod
def from_array(cls, schema, x, y_index):
    """é™æ€å·¥å‚æ–¹æ³•"""
    return cls(schema, (x, int(y_index)))

@classmethod
def from_java_instance(cls, schema, java_instance):
    """å¦ä¸€ä¸ªå·¥å‚æ–¹æ³•"""
    return cls(schema, java_instance)
```

### 6.2 ğŸ” ç±»å‹å®‰å…¨æœºåˆ¶

#### 6.2.1 ç±»å‹åˆ«åï¼ˆType Aliasï¼‰

```python
# type_alias.py
FeatureVector = NDArray[double]  # æ¯” np.ndarray æ›´å…·ä½“
LabelIndex = int                 # è¯­ä¹‰åŒ–å‘½å
```

#### 6.2.2 æ¡ä»¶å¯¼å…¥é¿å…å¾ªç¯ä¾èµ–

```python
from typing import TYPE_CHECKING

if TYPE_CHECKING:  # ä»…ç±»å‹æ£€æŸ¥æ—¶ä¸º True
    from openmoa.stream import Schema  # è¿è¡Œæ—¶ä¸æ‰§è¡Œ

def __init__(self, schema: "Schema", ...):  # å­—ç¬¦ä¸²å½¢å¼çš„å‰å‘å¼•ç”¨
    ...
```

### 6.3 âš¡ æ€§èƒ½ä¼˜åŒ–æŠ€å·§

#### 6.3.1 ç¼“å­˜æœºåˆ¶

```python
# å±æ€§åªè®¡ç®—ä¸€æ¬¡ï¼Œåç»­è®¿é—®ç›´æ¥è¿”å›ç¼“å­˜
self._x: Optional[FeatureVector] = None

@property
def x(self):
    if self._x is not None:
        return self._x  # O(1) ç¼“å­˜å‘½ä¸­
    # ... è®¡ç®— ...
    self._x = result    # å­˜å…¥ç¼“å­˜
    return self._x
```

#### 6.3.2 æ‰¹é‡æ•°ç»„æ“ä½œ

```python
# Java â†’ Python è½¬æ¢
jx[: len(self.x)] = self.x  # NumPy æ‰¹é‡èµ‹å€¼ï¼Œæ¯” for å¾ªç¯å¿«

# ä½†æå–æ—¶ä»éœ€å¾ªç¯ï¼ˆå— JPype é™åˆ¶ï¼‰
for i in range(0, moa_instance.numInputAttributes()):
    self._x[i] = moa_instance.value(i)
```

### 6.4 ğŸ›¡ï¸ é”™è¯¯å¤„ç†

```python
# ç±»å‹æ£€æŸ¥
if isinstance(instance, InstanceExample):
    ...
elif isinstance(instance, np.ndarray):
    ...
else:
    raise ValueError(f"Given instance type unsupported: {type(instance)}")

# æ–­è¨€
assert self._x.ndim == 1, "Feature vector must be 1D."

# çŠ¶æ€æ£€æŸ¥
if self._y_index is not None:
    return self._y_index
elif self._java_instance is not None:
    ...
else:
    raise ValueError(f"{self.__class__.__name__} must have a y_index.")
```

---

## 7. æ½œåœ¨é—®é¢˜ä¸æ”¹è¿›å»ºè®®

### 7.1 ğŸ› å·²è¯†åˆ«é—®é¢˜

#### é—®é¢˜ 1ï¼šJava è½¬æ¢çš„ for å¾ªç¯ç“¶é¢ˆ

```python
# å½“å‰å®ç°ï¼šé€å…ƒç´ æå–
for i in range(0, moa_instance.numInputAttributes()):
    self._x[i] = moa_instance.value(i)
```

**é£é™©**ï¼šå¯¹äºé«˜ç»´æ•°æ®ï¼ˆå¦‚æ–‡æœ¬ç‰¹å¾ d=10000+ï¼‰ï¼Œå¾ªç¯å¼€é”€æ˜¾è‘—ã€‚

**å»ºè®®æ”¹è¿›**ï¼š
```python
# æ¢ç´¢ JPype æ˜¯å¦æ”¯æŒæ‰¹é‡è½¬æ¢
# æˆ–ä½¿ç”¨ MOA çš„ toDoubleArray() æ–¹æ³•ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
values = moa_instance.toDoubleArray()  # å‡è®¾å­˜åœ¨
self._x = np.array(values[:num_input_attrs])
```

#### é—®é¢˜ 2ï¼šåŠ¨æ€å±æ€§çš„ç±»å‹æ£€æŸ¥ç¼ºå¤±

```python
# stream_wrapper.py ä¸­åŠ¨æ€æ·»åŠ å±æ€§
new_instance.feature_indices = valid_indices  # æ²¡æœ‰ç±»å‹å£°æ˜

# ä¸‹æ¸¸ä½¿ç”¨
if hasattr(instance, "feature_indices"):  # è¿è¡Œæ—¶æ£€æŸ¥
    ...
```

**å»ºè®®æ”¹è¿›**ï¼š
```python
# æ–¹æ¡ˆ1ï¼šå®šä¹‰åè®®ï¼ˆProtocolï¼‰
from typing import Protocol

class SparseAwareInstance(Protocol):
    feature_indices: np.ndarray

# æ–¹æ¡ˆ2ï¼šä½¿ç”¨ dataclass æˆ– attrs
@dataclass
class InstanceWithIndices:
    base: Instance
    feature_indices: np.ndarray
```

#### é—®é¢˜ 3ï¼š_set_y æ–¹æ³•å‘½åä¸å¤Ÿæ¸…æ™°

```python
def _set_y(self, instance: DenseInstance) -> DenseInstance:
    """åç§°æš—ç¤ºæ˜¯ setterï¼Œä½†å®é™…æ˜¯åœ¨æ„å»º Java å®ä¾‹æ—¶çš„é’©å­"""
```

**å»ºè®®æ”¹è¿›**ï¼š
```python
def _configure_target_attribute(self, instance: DenseInstance) -> DenseInstance:
    """æ›´æ¸…æ™°åœ°è¡¨è¾¾æ„å›¾"""
```

### 7.2 ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### å»ºè®® 1ï¼šé¢„åˆ†é…ä¼˜åŒ–

```python
# å½“å‰
self._x = np.empty(moa_instance.numInputAttributes())
for i in range(0, moa_instance.numInputAttributes()):
    self._x[i] = moa_instance.value(i)

# æ”¹è¿›ï¼šä½¿ç”¨åˆ—è¡¨æ¨å¯¼å¼ + ä¸€æ¬¡æ€§è½¬æ¢
self._x = np.array([moa_instance.value(i) for i in range(n)], dtype=np.float64)
```

#### å»ºè®® 2ï¼š__slots__ å‡å°‘å†…å­˜

```python
class Instance:
    __slots__ = ('_schema', '_java_instance', '_x')  # çº¦ 40% å†…å­˜èŠ‚çœ

    def __init__(self, ...):
        ...
```

### 7.3 ğŸ” å¯è¯»æ€§æ”¹è¿›

#### å»ºè®® 1ï¼šæå–å¸¸é‡

```python
# å½“å‰
jx = JArray(JDouble)(len(self.x) + 1)  # +1 æ˜¯ä»€ä¹ˆï¼Ÿ

# æ”¹è¿›
NUM_TARGET_ATTRIBUTES = 1  # MOA å®ä¾‹çš„ç›®æ ‡å±æ€§æ•°
jx = JArray(JDouble)(len(self.x) + NUM_TARGET_ATTRIBUTES)
```

#### å»ºè®® 2ï¼šç»Ÿä¸€å±æ€§è®¿é—®é£æ ¼

```python
# å½“å‰æ··ç”¨
self._y_index: Optional[LabelIndex] = None  # ä¸‹åˆ’çº¿å‰ç¼€
self._y_value: Optional[TargetValue] = None

# å»ºè®®ç»Ÿä¸€ä½¿ç”¨ @cached_property (Python 3.8+)
from functools import cached_property

@cached_property
def y_index(self) -> LabelIndex:
    if self._java_instance:
        return int(self.java_instance.getData().classValue())
    raise ValueError(...)
```

---

## 8. ä½¿ç”¨ç¤ºä¾‹

### 8.1 ğŸš€ åŸºæœ¬ç”¨æ³•

```python
from openmoa.datasets import ElectricityTiny
from openmoa.instance import LabeledInstance

# ä»æ•°æ®é›†è·å–å®ä¾‹
stream = ElectricityTiny()
instance: LabeledInstance = stream.next_instance()

# è®¿é—®ç‰¹å¾å‘é‡
print(f"Features: {instance.x}")
# â†’ Features: [0.    0.056 0.439 0.003 0.423 0.415]

# è®¿é—®ç±»åˆ«ä¿¡æ¯
print(f"Class index: {instance.y_index}")  # â†’ 1
print(f"Class label: {instance.y_label}")  # â†’ "1"

# è®¿é—® Schema
print(f"Num features: {instance.schema.get_num_attributes()}")  # â†’ 6
print(f"Num classes: {instance.schema.get_num_classes()}")      # â†’ 2
```

### 8.2 ğŸ“Š æ‰‹åŠ¨åˆ›å»ºå®ä¾‹

```python
from openmoa.stream import Schema
from openmoa.instance import LabeledInstance, RegressionInstance
import numpy as np

# 1. åˆ›å»º Schema
schema = Schema.from_custom(
    feature_names=["f1", "f2", "f3"],
    dataset_name="MyDataset",
    values_for_class_label=["positive", "negative"]
)

# 2. åˆ›å»ºåˆ†ç±»å®ä¾‹
x = np.array([0.1, 0.2, 0.3])
labeled_inst = LabeledInstance.from_array(schema, x, y_index=0)

print(labeled_inst)
# â†’ LabeledInstance(
# â†’     Schema(MyDataset),
# â†’     x=[0.1 0.2 0.3],
# â†’     y_index=0,
# â†’     y_label='positive'
# â†’ )

# 3. åˆ›å»ºå›å½’å®ä¾‹ï¼ˆéœ€è¦ä¸åŒçš„ Schemaï¼‰
reg_schema = Schema.from_custom(
    feature_names=["f1", "f2"],
    dataset_name="RegressionData",
    target_type='numeric'
)
reg_inst = RegressionInstance.from_array(reg_schema, np.array([1.0, 2.0]), y_value=3.14)

print(f"Target value: {reg_inst.y_value}")  # â†’ 3.14
```

### 8.3 ğŸ”„ ä¸ MOA å­¦ä¹ å™¨äº¤äº’

```python
from openmoa.classifier import HoeffdingTree
from openmoa.datasets import ElectricityTiny

stream = ElectricityTiny()
schema = stream.get_schema()
learner = HoeffdingTree(schema=schema)

for i, instance in enumerate(stream):
    if i >= 100:
        break

    # é¢„æµ‹ï¼ˆå†…éƒ¨è®¿é—® instance.java_instanceï¼‰
    pred = learner.predict(instance)

    # è®­ç»ƒï¼ˆå†…éƒ¨è®¿é—® instance.java_instanceï¼‰
    learner.train(instance)

    # instance.java_instance åœ¨é¦–æ¬¡è®¿é—®æ—¶æƒ°æ€§åˆ›å»º
    # åç»­è®¿é—®ç›´æ¥è¿”å›ç¼“å­˜
```

### 8.4 ğŸ”§ ä¸ Python å­¦ä¹ å™¨äº¤äº’

```python
from openmoa.classifier._fobos_classifier import FOBOSClassifier
from openmoa.datasets import Magic04
from openmoa.stream import ShuffledStream, OpenFeatureStream

# åˆ›å»ºç‰¹å¾æ¼”åŒ–æµ
base = ShuffledStream(Magic04(), random_seed=42)
stream = OpenFeatureStream(base, evolution_pattern="tds", total_instances=1000)

schema = stream.get_schema()
learner = FOBOSClassifier(schema=schema, alpha=1.0)

for instance in stream:
    # Python å­¦ä¹ å™¨åªè®¿é—® .x å’Œ .y_index
    # ä¸è§¦å‘ Java è½¬æ¢

    x = instance.x                    # NumPy æ•°ç»„
    y = instance.y_index              # æ•´æ•°

    # å¦‚æœæœ‰ feature_indicesï¼Œç”¨äºç¨€ç–æ›´æ–°
    if hasattr(instance, 'feature_indices'):
        indices = instance.feature_indices
        # learner å†…éƒ¨ä½¿ç”¨ indices è¿›è¡Œç¨€ç–æƒé‡æ›´æ–°

    pred = learner.predict(instance)
    learner.train(instance)
```

### 8.5 ğŸ“‹ è°ƒè¯•ä¸æ£€æŸ¥

```python
instance = stream.next_instance()

# æŸ¥çœ‹å®ä¾‹çš„å®Œæ•´è¡¨ç¤º
print(repr(instance))
# â†’ LabeledInstance(
# â†’     Schema(Magic04),
# â†’     x=[0.123 0.456 ... 0.789],
# â†’     y_index=1,
# â†’     y_label='g'
# â†’ )

# æ£€æŸ¥å†…éƒ¨çŠ¶æ€
print(f"Has cached x: {instance._x is not None}")
print(f"Has cached java: {instance._java_instance is not None}")

# å¼ºåˆ¶è§¦å‘è½¬æ¢
_ = instance.java_instance  # è§¦å‘ Python â†’ Java
print(f"Java string: {instance.java_instance.toString()}")
# â†’ "0.123,0.456,...,0.789,g,"
```

---

## ğŸ“ é™„å½•

### A. æœ¯è¯­å¯¹ç…§è¡¨

| ä¸­æ–‡æœ¯è¯­ | è‹±æ–‡æœ¯è¯­ | è¯´æ˜ |
|----------|----------|------|
| å®ä¾‹ | Instance | å•ä¸ªæ•°æ®ç‚¹ |
| ç‰¹å¾å‘é‡ | Feature Vector | è¾“å…¥å±æ€§æ•°ç»„ |
| ç±»åˆ«ç´¢å¼• | Label Index / Class Index | åˆ†ç±»æ ‡ç­¾çš„æ•°å­—è¡¨ç¤º |
| ç±»åˆ«æ ‡ç­¾ | Label / Class Label | åˆ†ç±»æ ‡ç­¾çš„å­—ç¬¦ä¸²è¡¨ç¤º |
| ç›®æ ‡å€¼ | Target Value | å›å½’ä»»åŠ¡çš„è¿ç»­ç›®æ ‡å˜é‡ |
| æƒ°æ€§æ±‚å€¼ | Lazy Evaluation | å»¶è¿Ÿè®¡ç®—ç›´åˆ°é¦–æ¬¡è®¿é—® |
| æ¨¡æ¿æ–¹æ³• | Template Method | å®šä¹‰ç®—æ³•éª¨æ¶ï¼Œå­ç±»è¦†ç›–å…·ä½“æ­¥éª¤ |
| å·¥å‚æ–¹æ³• | Factory Method | åˆ›å»ºå¯¹è±¡çš„é™æ€æ–¹æ³• |
| å¾ªç¯å¯¼å…¥ | Circular Import | æ¨¡å— A å¯¼å…¥ Bï¼ŒB åˆå¯¼å…¥ A |
| å‰å‘å¼•ç”¨ | Forward Reference | ç”¨å­—ç¬¦ä¸²å¼•ç”¨å°šæœªå®šä¹‰çš„ç±»å‹ |

### B. ç±»å‹åˆ«åå®šä¹‰

```python
# openmoa/type_alias.py

FeatureVector = NDArray[double]
"""ç‰¹å¾å‘é‡ï¼šåŒç²¾åº¦æµ®ç‚¹æ•°çš„ä¸€ç»´ NumPy æ•°ç»„"""

LabelIndex = int
"""ç±»åˆ«ç´¢å¼•ï¼šéè´Ÿæ•´æ•°ï¼Œè¡¨ç¤ºæ ‡ç­¾åœ¨æ ‡ç­¾åˆ—è¡¨ä¸­çš„ä½ç½®"""

LabelProbabilities = NDArray[double]
"""é¢„æµ‹æ¦‚ç‡ï¼šåŒç²¾åº¦æµ®ç‚¹æ•°æ•°ç»„ï¼Œå„ç±»åˆ«çš„é¢„æµ‹æ¦‚ç‡"""

Label = str
"""ç±»åˆ«æ ‡ç­¾ï¼šå­—ç¬¦ä¸²å½¢å¼çš„åˆ†ç±»æ ‡ç­¾"""

TargetValue = double
"""ç›®æ ‡å€¼ï¼šå›å½’ä»»åŠ¡ä¸­çš„è¿ç»­å› å˜é‡"""
```

### C. ç›¸å…³æ–‡ä»¶å¿«é€Ÿç´¢å¼•

| æ–‡ä»¶ | è·¯å¾„ | è¯´æ˜ |
|------|------|------|
| Instance æ¨¡å— | `src/openmoa/instance.py` | æœ¬æ–‡ä»¶ |
| ç±»å‹åˆ«å | `src/openmoa/type_alias.py` | ç±»å‹å®šä¹‰ |
| Stream åŸºç±» | `src/openmoa/stream/_stream.py` | åˆ›å»º Instance çš„æºå¤´ |
| Schema ç±» | `src/openmoa/stream/_stream.py:49` | æµç»“æ„æè¿° |
| FOBOS åˆ†ç±»å™¨ | `src/openmoa/classifier/_fobos_classifier.py` | ä½¿ç”¨ Instance çš„ç¤ºä¾‹ |
| Stream Wrapper | `src/openmoa/stream/stream_wrapper.py` | æ‰©å±• Instance çš„ç¤ºä¾‹ |

---

> ğŸ“ **æ–‡æ¡£ç‰ˆæœ¬**: 1.0
> **æœ€åæ›´æ–°**: 2026-02-11
> **ä½œè€…**: Claude Code Analysis
